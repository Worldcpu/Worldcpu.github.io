<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>AC自动机的进阶应用 | wjyppm's Blog</title><meta name="author" content="wjyppm"><meta name="copyright" content="wjyppm"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="0. 前言 你需要知道的芝士：  AC 自动机基础； Trie 树；  这里是进阶使用，所以会结合一些例题来讲解，读者应有 AC 自动机的基础芝士即可。  1. 自动机与 AC 自动机本质 考虑到大多数都是先学 AC 自动机，而很久以后才学自动机，这里有必要先给出概念，这样才能更好的理解后面的芝士。  1.1 自动机 自动机，在 OI 中一般我们涉及的是有限状态自动机，它拥有有限数量的状态，每个"><meta property="og:type" content="article"><meta property="og:title" content="AC自动机的进阶应用"><meta property="og:url" content="https://worldcpu.github.io/posts/6074ec1/index.html"><meta property="og:site_name" content="wjyppm's Blog"><meta property="og:description" content="0. 前言 你需要知道的芝士：  AC 自动机基础； Trie 树；  这里是进阶使用，所以会结合一些例题来讲解，读者应有 AC 自动机的基础芝士即可。  1. 自动机与 AC 自动机本质 考虑到大多数都是先学 AC 自动机，而很久以后才学自动机，这里有必要先给出概念，这样才能更好的理解后面的芝士。  1.1 自动机 自动机，在 OI 中一般我们涉及的是有限状态自动机，它拥有有限数量的状态，每个"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220808697_686ffa5e0afdb.webp"><meta property="article:published_time" content="2025-06-29T08:33:15.000Z"><meta property="article:modified_time" content="2025-09-28T13:11:28.611Z"><meta property="article:author" content="wjyppm"><meta property="article:tag" content="字符串"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220808697_686ffa5e0afdb.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "AC自动机的进阶应用",
  "url": "https://worldcpu.github.io/posts/6074ec1/",
  "image": "https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220808697_686ffa5e0afdb.webp",
  "datePublished": "2025-06-29T08:33:15.000Z",
  "dateModified": "2025-09-28T13:11:28.611Z",
  "author": [
    {
      "@type": "Person",
      "name": "wjyppm",
      "url": "https://worldcpu.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://worldcpu.github.io/posts/6074ec1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.clarity.ms"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/7.0.0/css/all.min.css"><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/fancyapps-ui/6.0.22/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>(()=>{const e={set:(e,t,o)=>{if(!o)return;const a=Date.now()+864e5*o;localStorage.setItem(e,JSON.stringify({value:t,expiry:a}))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const{value:o,expiry:a}=JSON.parse(t);if(!(Date.now()>a))return o;localStorage.removeItem(e)}};window.btf={saveToLocal:e,getScript:(e,t={})=>new Promise((o,a)=>{const n=document.createElement("script");n.src=e,n.async=!0,Object.entries(t).forEach(([e,t])=>n.setAttribute(e,t)),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),getCSS:(e,t)=>new Promise((o,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.href=e,t&&(n.id=t),n.onload=n.onreadystatechange=()=>{n.readyState&&!/loaded|complete/.test(n.readyState)||o()},n.onerror=a,document.head.appendChild(n)}),addGlobalFn:(e,t,o=!1,a=window)=>{const n=a.globalFn||{};n[e]=n[e]||{},n[e][o||Object.keys(n[e]).length]=t,a.globalFn=n}};const t=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},o=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};btf.activateDarkMode=t,btf.activateLightMode=o;const a=e.get("theme");"dark"===a?t():"light"===a&&o();const n=e.get("aside-status");void 0!==n&&document.documentElement.classList.toggle("hide-aside","hide"===n);/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})()</script><script>!function(t,e,n,c,r,s,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(s=e.createElement(c)).async=1,s.src="https://www.clarity.ms/tag/srmn9gtuyc",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(s,a)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:1,unescape:!1,languages:{hits_empty:"未找到符合您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:200,highlightFullpage:!1,highlightMacStyle:!0},copy:{success:"复制成功",error:"复制失败",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,infinitegrid:{js:"https://s4.zstatic.net/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!1,islazyloadPlugin:!0,isAnchor:!1,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"AC自动机的进阶应用",isHighlightShrink:!1,isToc:!0,pageType:"post"}</script><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/nav.css"><link rel="stylesheet" href="/css/touming.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image:url(https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1754709022174_【哲风壁纸】奇幻森林-柯娜：精神之桥.jpg)"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.luogu.com.cn/upload/usericon/578829.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220808697_686ffa5e0afdb.webp)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">wjyppm's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">AC自动机的进阶应用</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i> <span>返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">AC自动机的进阶应用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-29T08:33:15.000Z" title="发表于 2025-06-29 16:33:15">2025-06-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-28T13:11:28.611Z" title="更新于 2025-09-28 21:11:28">2025-09-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%97%E7%AC%A6%E4%B8%B2/">字符串</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">11.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>56分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="0-前言"><a class="markdownIt-Anchor" href="#0-前言"></a> 0. 前言</h1><p>你需要知道的芝士：</p><ul><li>AC 自动机基础；</li><li>Trie 树；</li></ul><p>这里是进阶使用，所以会结合一些例题来讲解，读者应有 AC 自动机的基础芝士即可。</p><h1 id="1-自动机与-ac-自动机本质"><a class="markdownIt-Anchor" href="#1-自动机与-ac-自动机本质"></a> 1. 自动机与 AC 自动机本质</h1><p>考虑到大多数都是先学 AC 自动机，而很久以后才学自动机，这里有必要先给出概念，这样才能更好的理解后面的芝士。</p><h2 id="11-自动机"><a class="markdownIt-Anchor" href="#11-自动机"></a> 1.1 自动机</h2><p>自动机，在 OI 中一般我们涉及的是有限状态自动机，它拥有有限数量的状态，每个状态代表不同的意义，每个状态可以通过输入自动机，让自动机切换到其他的状态。任意时刻状态机只能处在一个状态。</p><p>而有限状态机可以表示为一个有向图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752222970398_image.png" alt="image.png"></p><p>从图中看出来一个信息学竞赛一共包含 5 个状态：学信竟，学 whk，吃吃饭，睡睡觉，摸摸鱼。每种带有箭头的连线，表示可以从当前状态切换到其他的状态，以及切换的条件。</p><p>我们列个表格：</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">学信竟</th><th style="text-align:center">学 whk</th><th style="text-align:center">吃吃饭</th><th style="text-align:center">睡睡觉</th><th style="text-align:center">摸摸鱼</th></tr></thead><tbody><tr><td style="text-align:center">学信竟</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">去机房</td><td style="text-align:center"></td><td style="text-align:center">摆烂时间到</td></tr><tr><td style="text-align:center">学 whk</td><td style="text-align:center">信竟时间到</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">回去午睡</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">吃吃饭</td><td style="text-align:center">去食堂</td><td style="text-align:center">去教室</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">睡睡觉</td><td style="text-align:center"></td><td style="text-align:center">回教室</td><td style="text-align:center">被吵醒</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">摸摸鱼</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">回家</td><td style="text-align:center"></td></tr></tbody></table><p>表格中左侧第一列为当前状态。<br>表格中上方第一行为切换的下一个状态。<br>表格中每行从左到右为状态切换的条件(状态 A 能不能切换到状态B)。</p><p>举例：</p><ul><li>学 whk -&gt; 学信竟：条件（信竟时间到）。</li><li>学信竟 -&gt; 摸摸鱼：条件（摸鱼时间到）。</li><li>摸摸鱼 -&gt; 睡睡觉：条件（回家）。</li></ul><p>几个概念：</p><ul><li>状态：当前所处的状态，在当前状态下可以有不同的行为和属性。</li><li>转移：状态变更，满足条件是从一个状态转移到另一个状态。</li><li>动作：表示在给定时刻进行的活动。</li><li>条件：触发一个事件、当一个条件满足触发状态转移切换到另一个状态。</li></ul><p>一个自动机，我们应当还有起始状态，在本图中我们的起始状态是 “睡睡觉”。（不准通宵！）</p><p>那为啥叫自动呢，是因为只要输入符号和转移规则确定，状态变化是自动的，自动机可以自己通过设定好的路线（即有向图的边权）来进行转移。</p><p>而自动机的实质就是：状态集合（点） + 转移规则（边）。</p><p>在竞赛中的应用我们有 AC 自动机，后缀自动机，DP 套 DP等。</p><h2 id="12-trie-与-ac-自动机"><a class="markdownIt-Anchor" href="#12-trie-与-ac-自动机"></a> 1.2 Trie 与 AC 自动机</h2><p>那我们上面提到了自动机，那么，信竟中有哪些我们值得举例的呢？</p><p>例如字典树，我们看看字典树的形状，我们借用 OI-Wiki 的图：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://oi-wiki.org/string/images/trie1.png" alt=""></p><p>那我们回看上面的自动机表示图，你会发现两者十分相似，我们模拟一下 Trie 的过程。</p><p>我们把自动机丢在 1 号点，让自动机读入字符串。起始状态在 1 号点，让后我们输入一个字符 a，就转移到 2 号点，让后输入一个字符 b，转移到 6 号点，让后输入一个字符 a，转移到 11 号点。</p><p>那么实际上，字典树其实就是一个自动机，通过接受指定字符串集合中的元素来转移，而转移的时候就是利用 Trie 图上的边来进行转移。</p><p>而 AC 自动机，是 Trie+Fail 指针，本质上是 Trie 上的自动机。</p><p>Trie 不用说我们上面已经提到过了，那么既然 AC 自动机叫自动机，那么 Trie+Fail 这一甜蜜组合一定也能构成自动机吧？其实是的，Fail 指针实际上就是在 Trie 的有向转移图上进行拓展。在单模式匹配中，失败时需要回溯文本指针；而 AC 自动机通过失配指针<strong>自动匹配状态</strong>，让 Trie 进化为一条永通路，以便避免文本串匹配时一个模式串到结尾了没有地方可走的尴尬。</p><p>严格来说，AC自动机是一个<strong>带有失败转移的确定性有限状态自动机（DFA）</strong>，在经典的 Trie 上我们增加了失败状态的优化处理机制。而我们引入失配指针，是为了<strong>最小化状态数</strong>（避免为所有可能的失败情况显式建边），同时保持高效匹配。而AC自动机的 “自动” 正体现在其能根据预定义的转移规则（包括正常转移和失败转移），无需人工干预地完成多模式匹配。</p><h1 id="2-ac-自动机上-dp"><a class="markdownIt-Anchor" href="#2-ac-自动机上-dp"></a> 2. AC 自动机上 DP</h1><h2 id="21-状态设计"><a class="markdownIt-Anchor" href="#21-状态设计"></a> 2.1 状态设计</h2><p>我们上面讲自动机当然不是摆烂的，我们需要结合芝士进行讲解。</p><p>众所周知，AC 自动机上的 DP，一般来说都是这么设计状态<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span>，表示长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 的字符串在 AC 自动机上匹配到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 节点。但是我们为什么这个设计？</p><p>动态规划通过将问题分解为子问题，并存储子问题的解（状态）来避免重复计算。关键在于：</p><ul><li>状态定义；</li><li>状态转移；</li><li>边界确定；</li></ul><p>而 AC 自动机上 DP，本质就是自动机上的 DP，其本质就是：<strong>将问题的约束条件建模为一个自动机，在 DP 状态中增加自动机的状态维度，通过在自动机上逐层推进的转移规则指导 DP 的决策</strong>。因为自动机的状态是唯一确定的，通过 AC 自动机的有向转移图，我们就可以方便的进行状态转移，并进行答案统计。</p><p>通常来说，自动机上的 DP 我们需要自动机的状态，一般来说为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mclose">)</span></span></span></span>，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 是一个确定的顺序，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span> 代表自动机的状态。对应到 AC 自动机上，AC 自动机的状态是一个节点，所以我们定义<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span>，表示长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 的字符串在 AC 自动机上匹配到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 节点。</p><p>还是来看例题吧：</p><h2 id="22-例题"><a class="markdownIt-Anchor" href="#22-例题"></a> 2.2 例题</h2><h3 id="usaco12jan-video-game-g"><a class="markdownIt-Anchor" href="#usaco12jan-video-game-g"></a> USACO12JAN] Video Game G</h3><p>对输入的模板串建 AC 自动机，设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span> 表示前<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 个字符，最后一个跑到了 AC 自动机<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 号点的最大答案，我们只需要枚举对于每一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span> 下一个是字符是什么，题目中是 A，B，C。转移到下一个节点，让后跳 Fail 指针求答案，对于匹配到一个长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.03148em">k</span></span></span></span> 的模板串，有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>s</mi><mi>o</mi><mi>n</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>+</mo><mi>e</mi><mi>n</mi><mi>d</mi><mo stretchy="false">[</mo><mi>s</mi><mi>o</mi><mi>n</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f(i,son[j][k]) = \max(f(i-1,j)+end[son[j][k]]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mclose">]</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mclose">]</span><span class="mclose">]</span></span></span></span>。直接做就可以了。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">2e4</span><span class="number">+15</span>;</span><br><span class="line"><span class="type">int</span> n,K,f[MN][<span class="number">520</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">3</span>],fail[MN],end[MN],tot;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'A'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">        }  </span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">            end[u]+=end[fail[u]];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}t;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;K;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        t.<span class="built_in">insert</span>(s);</span><br><span class="line">    }</span><br><span class="line">    t.<span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">memset</span>(f,<span class="number">-0x3f</span>,<span class="built_in">sizeof</span>(f));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=K;i++) f[i][<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=K;i++){</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=t.tot;j++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">3</span>;k++){</span><br><span class="line">                f[i][t.t[j][k]]=<span class="built_in">max</span>(f[i][t.t[j][k]],f[i<span class="number">-1</span>][j]+t.end[t.t[j][k]]);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">-0x3f3f3f3f</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=t.tot;i++) ans=<span class="built_in">max</span>(ans,f[K][i]);</span><br><span class="line">    cout&lt;&lt;ans;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="jsoi2007-文本生成器"><a class="markdownIt-Anchor" href="#jsoi2007-文本生成器"></a> JSOI2007 文本生成器</h3><p>本部分是反向的计算 DP。</p><p>状态还是我们上面所说的，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span>，表示长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 的字符串在 AC 自动机上匹配到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 节点。但是题目中还有一个限制：“包含至少一个”，考虑容斥，答案就是整体减去一个模式串都不包含的文本串数。整体是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msup><mn>6</mn><mi>m</mi></msup></mrow><annotation encoding="application/x-tex">26^m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.664392em;vertical-align:0"></span><span class="mord">2</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span></span></span></span>，问题转化为求解第二部分。</p><p>文本串中不能出现模式串，所以我们要在一个字符串的末尾打标记<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>n</mi><msub><mi>d</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">end_{u}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.84444em;vertical-align:-.15em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，同时如果一个字符串的后缀也是模式串，那么它也不能出现在文本串中，所以我们要让<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>n</mi><msub><mi>d</mi><mi>u</mi></msub><mo>=</mo><mi>e</mi><mi>n</mi><msub><mi>d</mi><mrow><mi>f</mi><mi>a</mi><mi>i</mi><mi>l</mi><mo stretchy="false">[</mo><mi>u</mi><mo stretchy="false">]</mo></mrow></msub></mrow><annotation encoding="application/x-tex">end_{u}=end_{fail[u]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.84444em;vertical-align:-.15em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.04964em;vertical-align:-.3551999999999999em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.34480000000000005em"><span style="top:-2.5198em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.10764em">f</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:.01968em">l</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight">u</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.3551999999999999em"><span></span></span></span></span></span></span></span></span></span>。</p><p>那么转移方程就是避开模式串进行转移：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">dodp</span><span class="params">()</span></span>{</span><br><span class="line">    f[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++){</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=tot;j++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">26</span>;k++){</span><br><span class="line">                <span class="keyword">if</span>(!end[ch[j][k]]){</span><br><span class="line">                    f[i<span class="number">+1</span>][ch[j][k]]=(f[i<span class="number">+1</span>][ch[j][k]]+f[i][j])%MOD;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>那么第二部分答案就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow></msubsup><mi>f</mi><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum\limits_{i=1}^{cnt} f(m,i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4582300000000004em;vertical-align:-.9776689999999999em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4805610000000002em"><span style="top:-2.122331em;margin-left:0"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0000050000000003em"><span class="pstrut" style="height:3em"></span><span><span class="mop op-symbol small-op">∑</span></span></span><span style="top:-3.950005em;margin-left:0"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.9776689999999999em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span>，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">cnt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.61508em;vertical-align:0"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span> 表示 AC 自动机的点数，那么答案就是：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mn>2</mn><msup><mn>6</mn><mi>m</mi></msup><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow></munderover><mi>f</mi><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo><mspace></mspace><mspace width="1em"></mspace><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mspace width="0.3333333333333333em"></mspace><mn>10007</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">26^m - \sum\limits_{i=1}^{cnt} f(m,i) \pmod{10007}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.7977219999999999em;vertical-align:-.08333em"></span><span class="mord">2</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:3.05823em;vertical-align:-1.277669em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7805610000000003em"><span style="top:-1.872331em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:1em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:.3333333333333333em"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">7</span><span class="mclose">)</span></span></span></span></span></p><p>直接写：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MOD=<span class="number">1e4</span><span class="number">+7</span>,MN=<span class="number">120</span>,MK=<span class="number">1e5</span>;</span><br><span class="line"><span class="type">int</span> n,m,f[MN][MK];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> type&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">read</span><span class="params">(type &amp;x)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    x=<span class="number">0</span>;<span class="function"><span class="type">bool</span> <span class="title">flag</span><span class="params">(<span class="number">0</span>)</span></span>;<span class="type">char</span> ch=<span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(ch)) flag=ch==<span class="string">'-'</span>,ch=<span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="number">1</span>)+(x&lt;&lt;<span class="number">3</span>)+(ch^<span class="number">48</span>),ch=<span class="built_in">getchar</span>();</span><br><span class="line">    flag?x=-x:<span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> string <span class="title">stread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">getchar</span>();</span><br><span class="line">    string st1 = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">while</span> (!((ch &gt;= <span class="string">'A'</span>) &amp;&amp; (ch &lt;= <span class="string">'Z'</span>)))</span><br><span class="line">        ch = <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">while</span> ((ch &gt;= <span class="string">'A'</span>) &amp;&amp; (ch &lt;= <span class="string">'Z'</span>))</span><br><span class="line">        st1 += ch, ch = <span class="built_in">getchar</span>();</span><br><span class="line">    <span class="keyword">return</span> st1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Acauto</span>{</span><br><span class="line">    <span class="type">int</span> ch[MK][<span class="number">26</span>],tot,fail[MK],end[MK];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="keyword">if</span>(!ch[p][c-<span class="string">'A'</span>]) ch[p][c-<span class="string">'A'</span>]=++tot;</span><br><span class="line">            p=ch[p][c-<span class="string">'A'</span>];</span><br><span class="line">        }</span><br><span class="line">        end[p]=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(ch[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(ch[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> f=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="keyword">if</span>(ch[f][i]){ </span><br><span class="line">                    fail[ch[f][i]]=ch[fail[f]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(ch[f][i]);</span><br><span class="line">                    end[ch[f][i]]|=end[fail[ch[f][i]]];</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> ch[f][i]=ch[fail[f]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dodp</span><span class="params">()</span></span>{</span><br><span class="line">        f[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=tot;j++){</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">26</span>;k++){</span><br><span class="line">                    <span class="keyword">if</span>(!end[ch[j][k]]){</span><br><span class="line">                        f[i<span class="number">+1</span>][ch[j][k]]=(f[i<span class="number">+1</span>][ch[j][k]]+f[i][j])%MOD;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}ac;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">qpow</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span>{</span><br><span class="line">    <span class="type">int</span> ret=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(b){</span><br><span class="line">        <span class="keyword">if</span>(b&amp;<span class="number">1</span>) ret=(ret*a)%MOD;</span><br><span class="line">        a=a*a%MOD;</span><br><span class="line">        b&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">read</span>(n);</span><br><span class="line">    <span class="built_in">read</span>(m);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        s=<span class="built_in">stread</span>();</span><br><span class="line">        ac.<span class="built_in">insert</span>(s);</span><br><span class="line">    }</span><br><span class="line">    ac.<span class="built_in">build</span>();</span><br><span class="line">    ac.<span class="built_in">dodp</span>();</span><br><span class="line">    <span class="type">int</span> ans=<span class="built_in">qpow</span>(<span class="number">26</span>,m);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=ac.tot;i++){</span><br><span class="line">        ans=(ans-f[m][i]+MOD)%MOD;</span><br><span class="line">    }</span><br><span class="line">    cout&lt;&lt;ans;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="sdoi2014-数数"><a class="markdownIt-Anchor" href="#sdoi2014-数数"></a> SDOI2014 数数</h3><p>自动机上 DP 可以与许多不同类型的 DP 结合，因为实质上<strong>自动机上 DP 利用的是自动机的转移顺序</strong>，所以很灵活可以与许多类型的 DP 结合，这里是数位 DP。</p><p>注意到本题就是不让特定的模式数串出现，考虑到一个集合有许多模式数串，考虑 AC 自动机，因为自动机上的 DP 我们是必须要知道自动机跑到哪里了，有一个维度必须设计<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span></span></span></span> 表示 AC 自动机上的节点（即自动机状态）。本题在数位 DP 只需要关心自动机状态即可，考虑设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">[</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>s</mi><mi>t</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f[pos][st]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">[</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mclose">]</span></span></span></span> 表示现在从最高位填到第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">s</span></span></span></span> 位，当前 AC 自动机状态节点在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">st</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.61508em;vertical-align:0"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span>。通过记忆化搜索是很容易实现的，注意一下前导零也是算模式串里面的，注意实现细节。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">1520</span>,MOD=<span class="number">1e9</span><span class="number">+7</span>;</span><br><span class="line"><span class="type">int</span> m,a[MN],tot,f[MN][MN];</span><br><span class="line">string n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">12</span>],tot,fail[MN],end[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'0'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">            end[u]|=end[fail[u]];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}t;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> pos,<span class="type">bool</span> lim,<span class="type">bool</span> lead,<span class="type">int</span> st)</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(t.end[st]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pos) <span class="keyword">return</span> !lead;</span><br><span class="line">    <span class="keyword">if</span>(!lim&amp;&amp;!lead&amp;&amp;~f[pos][st]) <span class="keyword">return</span> f[pos][st];</span><br><span class="line">    <span class="type">int</span> up=lim?a[pos]:<span class="number">9</span>;</span><br><span class="line">    <span class="type">int</span> ret=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=up;i++){</span><br><span class="line">        ret=(ret+<span class="built_in">dfs</span>(pos<span class="number">-1</span>,lim&amp;&amp;i==up,(lead&amp;&amp;!i),(lead&amp;&amp;!i)?<span class="number">0</span>:t.t[st][i]))%MOD;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(!lim&amp;&amp;!lead) f[pos][st]=ret;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">solve</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">memset</span>(f,<span class="number">-1</span>,<span class="built_in">sizeof</span>(f));</span><br><span class="line">    tot=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> c:n){</span><br><span class="line">        a[++tot]=(<span class="type">int</span>)(c-<span class="string">'0'</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">reverse</span>(a<span class="number">+1</span>,a<span class="number">+1</span>+tot);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dfs</span>(tot,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        t.<span class="built_in">insert</span>(s);</span><br><span class="line">    }</span><br><span class="line">    t.<span class="built_in">build</span>();</span><br><span class="line">    cout&lt;&lt;<span class="built_in">solve</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="cf696d-legen"><a class="markdownIt-Anchor" href="#cf696d-legen"></a> CF696D Legen</h3><p>有的时候，转移过程过大，但是通过借助 AC 自动机状态数有的时候较小，我们可以通过矩阵快速幂来优化 DP 这一过程。</p><p>顺便推销自己优质文章：<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cubHVvZ3UuY29tLmNuL2FydGljbGUvZ2gza2hhdng">矩阵快速幂优化DP</a>。</p><p>有显然的转移，和第一道例题差不太多。设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span></span></span></span> 表示前<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 个字符，最后一个跑到了 AC 自动机<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 号点的最大答案，有显然的转移方程：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><msup><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>+</mo><mi>e</mi><mi>n</mi><mi>d</mi><mo stretchy="false">[</mo><msup><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i+1,j')=\max(f(i,j)+end[j'])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.801892em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.051892em;vertical-align:-.25em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.801892em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mclose">)</span></span></span></span></span></p><p>其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">j'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.946332em;vertical-align:-.19444em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 为当前状态<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.85396em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span></span></span></span> 转移后的节点，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>n</mi><mi>d</mi><mo stretchy="false">[</mo><msup><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">end[j']</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-.25em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 表示自动机在节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">j'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.946332em;vertical-align:-.19444em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.751892em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 上有多少模式串以该节点为结尾的数量。</p><p>但是问题在于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span></span></span></span> 太大啦！怎么办？观察数据范围，注意到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>≤</mo><mn>200</mn><mo separator="true">,</mo><mo>∑</mo><mi mathvariant="normal">∣</mi><msub><mi>S</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>≤</mo><mn>200</mn></mrow><annotation encoding="application/x-tex">n\le 200,\sum\limits |S_{i}|\le 200</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.7719400000000001em;vertical-align:-.13597em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-.25001em"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.05764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span></span></span></span>，也就是说一个模式串的长度是很小的，也就是说 AC 自动机转移的状态数是很小的，但是转移过程是巨大不可接受的，浓烈的矩阵优化味道，考虑矩阵快速幂优化。我们可以把转移图当作在有向图上进行转移，我们把 AC 自动机的图当作邻接矩阵存起来，让后利用广义矩阵乘法矩阵快速幂，接着再给初始状态以其他状态作为结束状态的权值和取个最大值即可。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">201</span>,INF=<span class="number">1e9</span>;</span><br><span class="line"><span class="type">int</span> n,L,a[MN],ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Matrix</span>{</span><br><span class="line">    <span class="type">int</span> mat[MN][MN];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Matrix</span>(<span class="type">int</span> x=<span class="number">-1e9</span>){</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;MN;i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;MN;j++){</span><br><span class="line">                mat[i][j]=-INF;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;MN;i++){</span><br><span class="line">            mat[i][i]=x;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    Matrix <span class="keyword">operator</span> *(<span class="type">const</span> Matrix &amp;x)<span class="type">const</span>{</span><br><span class="line">        Matrix ret;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;MN;i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;MN;j++){</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;MN;k++){</span><br><span class="line">                    ret.mat[i][j]=<span class="built_in">max</span>(ret.mat[i][j],mat[i][k]+x.mat[k][j]);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}G;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">26</span>],tot,fail[MN],end[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,<span class="type">int</span> val)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]+=val;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">            end[u]+=end[fail[u]];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=tot;i++){</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">26</span>;j++){</span><br><span class="line">                G.mat[i][t[i][j]]=end[t[i][j]];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}t;</span><br><span class="line"></span><br><span class="line"><span class="function">Matrix <span class="title">ksm</span><span class="params">(Matrix a,<span class="type">int</span> b)</span></span>{</span><br><span class="line">    <span class="function">Matrix <span class="title">ret</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(b){</span><br><span class="line">        <span class="keyword">if</span>(b&amp;<span class="number">1</span>) ret=ret*a;</span><br><span class="line">        a=a*a;</span><br><span class="line">        b&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;L;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        cin&gt;&gt;a[i];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        t.<span class="built_in">insert</span>(s,a[i]);  </span><br><span class="line">    }</span><br><span class="line">    t.<span class="built_in">build</span>();</span><br><span class="line">    Matrix QwQ=<span class="built_in">ksm</span>(G,L);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=t.tot;i++){</span><br><span class="line">        ret=<span class="built_in">max</span>(ret,QwQ.mat[<span class="number">0</span>][i]);</span><br><span class="line">    }</span><br><span class="line">    cout&lt;&lt;ret;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="uva1401-remeber-the-word"><a class="markdownIt-Anchor" href="#uva1401-remeber-the-word"></a> UVA1401 Remeber the Word</h3><p>来点不一样的，Trie 上 DP，别忘了 Trie 也是一个自动机！</p><p>设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>→</mo><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">i \to len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.69444em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span> 有多少种表示方法，转移如下：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left right" columnspacing="0em 1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>∑</mo><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>s</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mtext>&nbsp;可以由多个字典拼成</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}f(i) &amp; = \sum\limits f(j+1) &amp; s _{i}\in [i+1,j]\text{ 可以由多个字典拼成} \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.90001em;vertical-align:-.7000050000000001em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.200005em"><span style="top:-3.200005em"><span class="pstrut" style="height:3.05em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7000050000000001em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.200005em"><span style="top:-3.200005em"><span class="pstrut" style="height:3.05em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mop op-symbol large-op" style="position:relative;top:-.000004999999999977245em">∑</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7000050000000001em"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em"></span><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.200005em"><span style="top:-3.200005em"><span class="pstrut" style="height:3.05em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.05724em">j</span><span class="mclose">]</span><span class="mord text"><span class="mord">&nbsp;</span><span class="mord cjk_fallback">可以由多个字典拼成</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.7000050000000001em"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>利用字典树就可以快速判断，DP 结果为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span></span>。</p><h3 id="hnoi2004-l语言"><a class="markdownIt-Anchor" href="#hnoi2004-l语言"></a> HNOI2004 L语言</h3><p>本题目是状压 DP 的运用用于优化 DP 过程中跳 Fail 的复杂度。</p><p>有一个显然的思路就是建 AC 自动机，让后在子殴打凝固剂上对于所有 fail 指针的子串，让后取最大值得到答案，但是这样的复杂度不是线性因为要跳 fail。</p><p>根据题目特殊性质，所有单词长度只有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span></span></span></span>？不难考虑到状压，但是我们要状压什么？我们的时间瓶颈在于跳 fail 这一步，我们不妨将其优化到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>！</p><p>我们可以将前<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn></mrow><annotation encoding="application/x-tex">20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">2</span><span class="mord">0</span></span></span></span> 位字母所有可能的字串长度存下来，并压缩到状态中，并存于每个字节点中。</p><p>那么我们插入和建 fail 可以这么写：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,<span class="type">int</span> id)</span></span>{</span><br><span class="line">    <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">        <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">        p=t[p][k];</span><br><span class="line">    }</span><br><span class="line">    end[p]=id;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">    queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">        <span class="keyword">if</span>(t[<span class="number">0</span>][i]){</span><br><span class="line">            q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">            dep[t[<span class="number">0</span>][i]]=<span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">        <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        st[u]=st[fail[u]];</span><br><span class="line">        <span class="keyword">if</span>(end[u]){</span><br><span class="line">            st[u]|=<span class="number">1</span>&lt;&lt;(dep[u]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="type">int</span> v=t[u][i];</span><br><span class="line">            <span class="keyword">if</span>(v){</span><br><span class="line">                fail[v]=t[fail[u]][i];</span><br><span class="line">                dep[v]=dep[u]<span class="number">+1</span>;</span><br><span class="line">                q.<span class="built_in">push</span>(v);</span><br><span class="line">            }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>而查询我们这么写：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(string s)</span></span>{</span><br><span class="line">    <span class="type">int</span> p=<span class="number">0</span>,mx=<span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> now=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.<span class="built_in">length</span>();i++){</span><br><span class="line">        <span class="type">int</span> k=s[i]-<span class="string">'a'</span>;</span><br><span class="line">        p=t[p][k];</span><br><span class="line">        now&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(st[p]&amp;now) now|=<span class="number">1</span>,mx=i<span class="number">+1</span>; <span class="comment">// 若与不为 0 那么长度集交集非空，那就是有匹配串。</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> mx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>代码如下：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">3e6</span><span class="number">+15</span>;</span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">26</span>],tot,end[MN],dep[MN],fail[MN],st[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,<span class="type">int</span> id)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]=id;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]){</span><br><span class="line">                q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">                dep[t[<span class="number">0</span>][i]]=<span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            st[u]=st[fail[u]];</span><br><span class="line">            <span class="keyword">if</span>(end[u]){</span><br><span class="line">                st[u]|=<span class="number">1</span>&lt;&lt;(dep[u]);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    dep[v]=dep[u]<span class="number">+1</span>;</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>,mx=<span class="number">0</span>;</span><br><span class="line">        <span class="type">unsigned</span> now=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;s.<span class="built_in">length</span>();i++){</span><br><span class="line">            <span class="type">int</span> k=s[i]-<span class="string">'a'</span>;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">            now&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(st[p]&amp;now) now|=<span class="number">1</span>,mx=i<span class="number">+1</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> mx;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ly</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">namespace</span> IO</span><br><span class="line">    {</span><br><span class="line">        <span class="meta">#<span class="keyword">ifndef</span> LOCAL</span></span><br><span class="line">            <span class="keyword">constexpr</span> <span class="keyword">auto</span> maxn=<span class="number">1</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line">            <span class="type">char</span> in[maxn],out[maxn],*p1=in,*p2=in,*p3=out;</span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> getchar() (p1==p2&amp;&amp;(p2=(p1=in)+fread(in,1,maxn,stdin),p1==p2)?EOF:*p1++)</span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> flush() (fwrite(out,1,p3-out,stdout))</span></span><br><span class="line">            <span class="meta">#<span class="keyword">define</span> putchar(x) (p3==out+maxn&amp;&amp;(flush(),p3=out),*p3++=(x))</span></span><br><span class="line">            <span class="keyword">class</span> <span class="title class_">Flush</span>{<span class="keyword">public</span>:~<span class="built_in">Flush</span>(){<span class="built_in">flush</span>();}}_;</span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">namespace</span> usr</span><br><span class="line">        {</span><br><span class="line">            <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> type&gt;</span></span><br><span class="line"><span class="function">            <span class="keyword">inline</span> type <span class="title">read</span><span class="params">(type &amp;x)</span></span></span><br><span class="line"><span class="function">            </span>{</span><br><span class="line">                x=<span class="number">0</span>;<span class="function"><span class="type">bool</span> <span class="title">flag</span><span class="params">(<span class="number">0</span>)</span></span>;<span class="type">char</span> ch=<span class="built_in">getchar</span>();</span><br><span class="line">                <span class="keyword">while</span>(!<span class="built_in">isdigit</span>(ch)) flag^=ch==<span class="string">'-'</span>,ch=<span class="built_in">getchar</span>();</span><br><span class="line">                <span class="keyword">while</span>(<span class="built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="number">1</span>)+(x&lt;&lt;<span class="number">3</span>)+(ch^<span class="number">48</span>),ch=<span class="built_in">getchar</span>();</span><br><span class="line">                <span class="keyword">return</span> flag?x=-x:x;</span><br><span class="line">            }</span><br><span class="line">            <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> type&gt;</span></span><br><span class="line"><span class="function">            <span class="keyword">inline</span> <span class="type">void</span> <span class="title">write</span><span class="params">(type x)</span></span></span><br><span class="line"><span class="function">            </span>{</span><br><span class="line">                x&lt;<span class="number">0</span>?x=-x,<span class="built_in">putchar</span>(<span class="string">'-'</span>):<span class="number">0</span>;</span><br><span class="line">                <span class="type">static</span> <span class="type">short</span> Stack[<span class="number">50</span>],<span class="built_in">top</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">do</span> Stack[++top]=x%<span class="number">10</span>,x/=<span class="number">10</span>;<span class="keyword">while</span>(x);</span><br><span class="line">                <span class="keyword">while</span>(top) <span class="built_in">putchar</span>(Stack[top--]|<span class="number">48</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="function"><span class="keyword">inline</span> <span class="type">char</span> <span class="title">read</span><span class="params">(<span class="type">char</span> &amp;x)</span></span>{<span class="keyword">do</span> x=<span class="built_in">getchar</span>();<span class="keyword">while</span>(<span class="built_in">isspace</span>(x));<span class="keyword">return</span> x;}</span><br><span class="line">            <span class="function"><span class="keyword">inline</span> <span class="type">char</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> &amp;x)</span></span>{<span class="keyword">return</span> <span class="built_in">putchar</span>(x);}</span><br><span class="line">            <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">read</span><span class="params">(<span class="type">char</span> *x)</span></span>{<span class="type">static</span> <span class="type">char</span> ch;<span class="built_in">read</span>(ch);<span class="keyword">do</span> *(x++)=ch;<span class="keyword">while</span>(!<span class="built_in">isspace</span>(ch=<span class="built_in">getchar</span>())&amp;&amp;~ch);}</span><br><span class="line">            <span class="keyword">template</span>&lt;<span class="keyword">typename</span> type&gt;<span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">write</span><span class="params">(type *x)</span></span>{<span class="keyword">while</span>(*x)<span class="built_in">putchar</span>(*(x++));}</span><br><span class="line">            <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">read</span><span class="params">(string &amp;x)</span></span>{<span class="type">static</span> <span class="type">char</span> ch;<span class="built_in">read</span>(ch),x.<span class="built_in">clear</span>();<span class="keyword">do</span> x+=ch;<span class="keyword">while</span>(!<span class="built_in">isspace</span>(ch=<span class="built_in">getchar</span>())&amp;&amp;~ch);}</span><br><span class="line">            <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp;x)</span></span>{<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>,len=x.<span class="built_in">length</span>();i&lt;len;++i)<span class="built_in">putchar</span>(x[i]);}</span><br><span class="line">            <span class="keyword">template</span>&lt;<span class="keyword">typename</span> type,<span class="keyword">typename</span>...T&gt;<span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">read</span><span class="params">(type &amp;x,T&amp;...y)</span></span>{<span class="built_in">read</span>(x),<span class="built_in">read</span>(y...);}</span><br><span class="line">            <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> type,<span class="keyword">typename</span>...T&gt;</span></span><br><span class="line"><span class="function">            <span class="keyword">inline</span> <span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> type &amp;x,<span class="type">const</span> T&amp;...y)</span></span>{<span class="built_in">write</span>(x),<span class="built_in">putchar</span>(<span class="string">' '</span>),<span class="built_in">write</span>(y...),<span class="keyword">sizeof</span>...(y)^<span class="number">1</span>?<span class="number">0</span>:<span class="built_in">putchar</span>(<span class="string">'\n'</span>);}</span><br><span class="line">            <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> type&gt;</span></span><br><span class="line"><span class="function">            <span class="keyword">inline</span> <span class="type">void</span> <span class="title">put</span><span class="params">(<span class="type">const</span> type &amp;x,<span class="type">bool</span> flag=<span class="number">1</span>)</span></span>{<span class="built_in">write</span>(x),flag?<span class="built_in">putchar</span>(<span class="string">'\n'</span>):<span class="built_in">putchar</span>(<span class="string">' '</span>);}</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">#<span class="keyword">ifndef</span> LOCAL</span></span><br><span class="line">            <span class="meta">#<span class="keyword">undef</span> getchar</span></span><br><span class="line">            <span class="meta">#<span class="keyword">undef</span> flush</span></span><br><span class="line">            <span class="meta">#<span class="keyword">undef</span> putchar</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    }<span class="keyword">using</span> <span class="keyword">namespace</span> IO::usr;</span><br><span class="line">}<span class="keyword">using</span> <span class="keyword">namespace</span> ly::IO::usr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">read</span>(n,m);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        <span class="built_in">read</span>(s);</span><br><span class="line">        t.<span class="built_in">insert</span>(s,i);</span><br><span class="line">    }</span><br><span class="line">    t.<span class="built_in">build</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++){</span><br><span class="line">        string s;</span><br><span class="line">        <span class="built_in">read</span>(s);</span><br><span class="line">        <span class="built_in">put</span>(t.<span class="built_in">query</span>(s));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="3-fail-树"><a class="markdownIt-Anchor" href="#3-fail-树"></a> 3. Fail 树</h1><p>有的时候，我们的复杂度瓶颈就在于跳 Fail 这一步。</p><p>思考一下&nbsp;AC 自动机的匹配过程：从第一个字符开始，<strong>每到达一个节点&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span>，就从<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span> 开始不断跳&nbsp;fail 到根</strong>。期间<strong>跳到的节点代表的串都在文本串中出现</strong>。</p><p>既然我们可以从文本串每一位向上跳 fail 找模式串结尾节点，那么，我们可以倒过来！我们从结尾节点逆着找 fail 找文本串节点！</p><p>那么，<strong>从结尾节点开始逆着跳&nbsp;fail，期间跳到的文本串节点个数就是这个模式串在文本串中出现的次数。</strong></p><p>而 Fail 树，就是 AC 自动机建立好之后，只留下反向的 Fail 指针作为边，就得到的 Fail 树：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.picui.cn/free/2025/06/29/6860b61526115.png" alt="1751168540018.png"></p><p>而这颗树是在一个 Trie 的基础上产生的，所以这棵树上的每个点都是一个字符串的前缀，而且每个字符串的每个前缀在这棵树上都对应着一个点。其次，由于 fail 指针，每个点父节点的字符串都是这个点字符串的后缀，并且树上没有更长的它的后缀。也就是说，对于字符串<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">s</span></span></span></span>，在 Fail 树上的祖先就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">s</span></span></span></span> 的所有子串。</p><p>这是一个 Trick：一个串对应终止节点在 fail 树上到根的这段路径就是他的所有子串。我们后面会提到的。</p><p>而对于任意两个节点，它们在 Fail 树上的 LCA 就是它们所共同拥有的子串。</p><p>那么怎么优化跳 Fail 呢？只需要将每个属于文本串的终止节点权值设置为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span>，那么节点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span> 的子树总权值就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span> 代表的串在文本串中出现的次数。</p><p>那怎么快速求呢？这里有一个 Trick：子树的 DFN 序是连续的一个区间。那么我们就可以通过 DFS 序加树状数组来进行实现，接下来我们来看例题：</p><h2 id="p2414-noi2011-阿狸的打字机"><a class="markdownIt-Anchor" href="#p2414-noi2011-阿狸的打字机"></a> P2414 [NOI2011] 阿狸的打字机</h2><p>首先一个很 native 的想法就是把所有串拿出来建 AC 自动机，让后暴力跳 fail 找<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span> 串的末尾，但是这样时间复杂度是飞起的。</p><p>但是，我们在跳 fail 啊，我们是不是可以用上面的思路来求解呢？每次查询从<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span> 串向上跳到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">x</span></span></span></span> 终止节点，而反过来就是往子树跳能达到多少个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span> 串的节点，这不就是我们上面所说的吗！我们每次把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span> 这个串插入树状数组的时候，只需要对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">y</span></span></span></span> 所在子树<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">+</span><span class="mord">1</span></span></span></span> 即可，对应到 DFN 上就是区间加。这不就是树状数组加差分吗！对于结束的位置打&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72777em;vertical-align:-.08333em"></span><span class="mord">−</span><span class="mord">1</span></span></span></span>，其余打&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span>。让后就做完了，代码如下：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">8e5</span><span class="number">+15</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Query</span>{ <span class="type">int</span> x,y,id; } qry[MN];</span><br><span class="line"><span class="type">int</span> n, siz[MN], dfn[MN], ans[MN],stk[MN], dtot;</span><br><span class="line">string st;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; ft[MN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span> {</span><br><span class="line">    <span class="type">int</span> t[MN];</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span> </span>{ <span class="keyword">return</span> x&amp;-x; }</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> x)</span> </span>{</span><br><span class="line">        <span class="type">int</span> ret=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(x&gt;<span class="number">0</span>) ret+=t[x], x-=<span class="built_in">lowbit</span>(x);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> k)</span> </span>{</span><br><span class="line">        <span class="keyword">while</span>(x&lt;MN) t[x]+=k, x+=<span class="built_in">lowbit</span>(x);</span><br><span class="line">    }</span><br><span class="line">} bit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ACAuto {</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span> { <span class="type">int</span> ch[<span class="number">26</span>], fail; } t[MN];</span><br><span class="line">    <span class="type">int</span> tot, g_top, ctot, cut[MN], sta[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">buildAC</span><span class="params">(string str)</span> </span>{</span><br><span class="line">        <span class="type">int</span> p = <span class="number">0</span>;</span><br><span class="line">        g_top = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;str.<span class="built_in">length</span>(); i++) {</span><br><span class="line">            <span class="keyword">if</span> (str[i]&gt;=<span class="string">'a'</span> &amp;&amp; str[i]&lt;=<span class="string">'z'</span>) {</span><br><span class="line">                <span class="type">int</span> ch = str[i]-<span class="string">'a'</span>;</span><br><span class="line">                <span class="keyword">if</span> (!t[p].ch[ch]) t[p].ch[ch] = ++tot;</span><br><span class="line">                p = t[p].ch[ch];</span><br><span class="line">                sta[++g_top] = p;</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (str[i]==<span class="string">'B'</span>) {</span><br><span class="line">                p = sta[--g_top];</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                cut[++ctot] = p;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span> </span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">26</span>; i++) {</span><br><span class="line">            <span class="keyword">if</span> (t[<span class="number">0</span>].ch[i]) {</span><br><span class="line">                q.<span class="built_in">push</span>(t[<span class="number">0</span>].ch[i]);</span><br><span class="line">                ft[<span class="number">0</span>].<span class="built_in">push_back</span>(t[<span class="number">0</span>].ch[i]);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span> (!q.<span class="built_in">empty</span>()) {</span><br><span class="line">            <span class="type">int</span> f = q.<span class="built_in">front</span>(); q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">26</span>; i++) {</span><br><span class="line">                <span class="type">int</span> &amp;v = t[f].ch[i];</span><br><span class="line">                <span class="keyword">if</span> (v) {</span><br><span class="line">                    t[v].fail = t[t[f].fail].ch[i];</span><br><span class="line">                    ft[t[v].fail].<span class="built_in">push_back</span>(v);</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    v = t[t[f].fail].ch[i];</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> ACAuto;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">cmp</span><span class="params">(Query x, Query y)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> x.y != y.y ? x.y &lt; y.y : x.id &lt; y.id;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span> </span>{</span><br><span class="line">    dfn[u] = ++dtot;</span><br><span class="line">    siz[u] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> v : ft[u]) {</span><br><span class="line">        <span class="built_in">dfs</span>(v);</span><br><span class="line">        siz[u] += siz[v];</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    cin &gt;&gt; st;</span><br><span class="line">    cin &gt;&gt; n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>; i&lt;=n; i++) {</span><br><span class="line">        cin &gt;&gt; qry[i].x &gt;&gt; qry[i].y;</span><br><span class="line">        qry[i].id = i;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">sort</span>(qry<span class="number">+1</span>, qry+n<span class="number">+1</span>, cmp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">buildAC</span>(st);</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>, p=<span class="number">0</span>, top=<span class="number">0</span>, pt=<span class="number">0</span>, up=<span class="number">0</span>; i&lt;=n; i++) {</span><br><span class="line">        <span class="keyword">while</span> (up &lt; qry[i].y) {</span><br><span class="line">            <span class="keyword">if</span> (st[pt]&gt;=<span class="string">'a'</span> &amp;&amp; st[pt]&lt;=<span class="string">'z'</span>) {</span><br><span class="line">                <span class="type">int</span> ch = st[pt]-<span class="string">'a'</span>;</span><br><span class="line">                p = t[p].ch[ch];</span><br><span class="line">                stk[++top] = p;</span><br><span class="line">                bit.<span class="built_in">update</span>(dfn[p], <span class="number">1</span>);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (st[pt]==<span class="string">'B'</span>) {</span><br><span class="line">                bit.<span class="built_in">update</span>(dfn[p], <span class="number">-1</span>);</span><br><span class="line">                p = stk[--top];</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                up++;</span><br><span class="line">            }</span><br><span class="line">            pt++;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> node = cut[qry[i].x];</span><br><span class="line">        ans[qry[i].id]=bit.<span class="built_in">query</span>(dfn[node]+siz[node]<span class="number">-1</span>)- bit.<span class="built_in">query</span>(dfn[node]<span class="number">-1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>; i&lt;=n; i++) cout &lt;&lt; ans[i] &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="cf1437g"><a class="markdownIt-Anchor" href="#cf1437g"></a> CF1437G</h2><p>用到上面我们的 Trick：一个串对应终止节点在 fail 树上到根的这段路径就是他的所有子串。</p><p>那么现在问题转化为单点修改和在 Fail 树上一条链查询权值的最大值，对 Fail 树上进行树链剖分即可，代码如下：</p><p>但是有重复串，要用 Multiset 维护每个节点的最大权值。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">3e5</span><span class="number">+1145</span>;</span><br><span class="line"><span class="type">int</span> n,m,pval[MN];</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; adj[MN];</span><br><span class="line">multiset&lt;<span class="type">int</span>&gt; val[MN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">26</span>],tot,fail[MN],end[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,<span class="type">int</span> x)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[x]=p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=tot;i++){</span><br><span class="line">            adj[fail[i]].<span class="built_in">push_back</span>(i); </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Segment</span>{</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ls p&lt;&lt;1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rs p&lt;&lt;1|1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span>{</span><br><span class="line">        <span class="type">int</span> l,r,val;</span><br><span class="line">    }t[MN&lt;&lt;<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pushup</span><span class="params">(<span class="type">int</span> p)</span></span>{</span><br><span class="line">        t[p].val=<span class="built_in">max</span>(t[ls].val,t[rs].val);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>{</span><br><span class="line">        t[p].l=l;</span><br><span class="line">        t[p].r=r;</span><br><span class="line">        <span class="keyword">if</span>(l==r){</span><br><span class="line">            t[p].val=<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">build</span>(ls,l,mid);</span><br><span class="line">        <span class="built_in">build</span>(rs,mid<span class="number">+1</span>,r);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">modify</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> pos,<span class="type">int</span> k)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(t[p].l==t[p].r){</span><br><span class="line">            t[p].val=k;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=pos) <span class="built_in">modify</span>(ls,pos,k);</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">modify</span>(rs,pos,k);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> fl,<span class="type">int</span> fr)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(t[p].l&gt;=fl&amp;&amp;t[p].r&lt;=fr){</span><br><span class="line">            <span class="keyword">return</span> t[p].val;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> ret=<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=fl) ret=<span class="built_in">max</span>(ret,<span class="built_in">query</span>(ls,fl,fr));</span><br><span class="line">        <span class="keyword">if</span>(mid&lt;fr) ret=<span class="built_in">max</span>(ret,<span class="built_in">query</span>(rs,fl,fr));</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> ls </span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> rs</span></span><br><span class="line">}sg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Tree{</span><br><span class="line">    <span class="type">int</span> id[MN],dtot,siz[MN],dep[MN],fa[MN],hson[MN],htop[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> pre)</span></span>{</span><br><span class="line">        dep[u]=dep[pre]<span class="number">+1</span>;</span><br><span class="line">        siz[u]=<span class="number">1</span>;</span><br><span class="line">        fa[u]=pre;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> v:adj[u]){</span><br><span class="line">            <span class="keyword">if</span>(v==pre) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">dfs1</span>(v,u);</span><br><span class="line">            siz[u]+=siz[v];</span><br><span class="line">            <span class="keyword">if</span>(!hson[u]||siz[hson[u]]&lt;siz[v]) hson[u]=v;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> top)</span></span>{</span><br><span class="line">        htop[u]=top;</span><br><span class="line">        id[u]=++dtot;</span><br><span class="line">        <span class="keyword">if</span>(!hson[u]) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">dfs2</span>(hson[u],top);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> v:adj[u]){</span><br><span class="line">            <span class="keyword">if</span>(v==fa[u]||v==hson[u]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">dfs2</span>(v,v);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">querychain</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>{</span><br><span class="line">        <span class="type">int</span> ret=<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span>(htop[x]!=htop[y]){</span><br><span class="line">            <span class="keyword">if</span>(dep[htop[x]]&lt;dep[htop[y]]) <span class="built_in">swap</span>(x,y);</span><br><span class="line">            ret=<span class="built_in">max</span>(ret,sg.<span class="built_in">query</span>(<span class="number">1</span>,id[htop[x]],id[x]));</span><br><span class="line">            x=fa[htop[x]];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(dep[x]&gt;dep[y]) <span class="built_in">swap</span>(x,y);</span><br><span class="line">        ret=<span class="built_in">max</span>(ret,sg.<span class="built_in">query</span>(<span class="number">1</span>,id[x],id[y]));</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Tree;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        ac.<span class="built_in">insert</span>(s,i);</span><br><span class="line">    }</span><br><span class="line">    ac.<span class="built_in">build</span>();</span><br><span class="line">    sg.<span class="built_in">build</span>(<span class="number">1</span>,<span class="number">1</span>,MN<span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">dfs1</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">dfs2</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        sg.<span class="built_in">modify</span>(<span class="number">1</span>,id[ac.end[i]],<span class="number">0</span>);</span><br><span class="line">        pval[i]=<span class="number">0</span>;</span><br><span class="line">         val[ac.end[i]].<span class="built_in">insert</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++){</span><br><span class="line">        <span class="type">int</span> op;</span><br><span class="line">        cin&gt;&gt;op;</span><br><span class="line">        <span class="keyword">if</span>(op==<span class="number">1</span>){</span><br><span class="line">            <span class="type">int</span> x,y;</span><br><span class="line">            cin&gt;&gt;x&gt;&gt;y;</span><br><span class="line">            val[ac.end[x]].<span class="built_in">erase</span>(val[ac.end[x]].<span class="built_in">find</span>(pval[x]));</span><br><span class="line">            pval[x]=y;</span><br><span class="line">            val[ac.end[x]].<span class="built_in">insert</span>(pval[x]);</span><br><span class="line">            sg.<span class="built_in">modify</span>(<span class="number">1</span>,id[ac.end[x]],*<span class="built_in">prev</span>(val[ac.end[x]].<span class="built_in">end</span>()));</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            string s;</span><br><span class="line">            cin&gt;&gt;s;</span><br><span class="line">            <span class="type">int</span> p=<span class="number">0</span>,ret=<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">                <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">                p=ac.t[p][k];</span><br><span class="line">                ret=<span class="built_in">max</span>(ret,<span class="built_in">querychain</span>(<span class="number">0</span>,p));</span><br><span class="line">            }</span><br><span class="line">            cout&lt;&lt;ret&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="p5840-divljak"><a class="markdownIt-Anchor" href="#p5840-divljak"></a> P5840 Divljak</h2><p>首先先建出来 AC 自动机。搞出来 Fail 树。</p><p>我们暴力的思路就跳 Fail，将经过的路径的权值都加上 1，让后查询特定的终止节点被访问了多少次即可。那么怎么搬到 Fail 树上呢？我们利用树上差分的思想，首先把将要插入的字符串<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.13889em">P</span></span></span></span> 统计在 Trie 中走过的节点，再按照 DFN 排序，每相邻节点在树上位置加 1，表示多一个串匹配上，但是它们的 LCA 及其祖先显然多加了一次，减去 1 即可。自此，我们可以通过树链剖分加树状数组维护即可：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">2e6</span><span class="number">+15</span>;</span><br><span class="line"><span class="type">int</span> n,q,a[MN];</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; adj[MN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BIT</span>{</span><br><span class="line">    <span class="type">int</span> t[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> x)</span></span>{</span><br><span class="line">        <span class="keyword">return</span> x&amp;-x;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> x)</span></span>{</span><br><span class="line">        <span class="type">int</span> ret=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(x){</span><br><span class="line">            ret+=t[x];</span><br><span class="line">            x-=<span class="built_in">lowbit</span>(x);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">modify</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> k)</span></span>{</span><br><span class="line">        <span class="keyword">while</span>(x&lt;MN){</span><br><span class="line">            t[x]+=k;</span><br><span class="line">            x+=<span class="built_in">lowbit</span>(x);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}bit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">26</span>],tot=<span class="number">1</span>,fail[MN],end[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s,<span class="type">int</span> id)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[id]=p;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            t[<span class="number">0</span>][i]=<span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line">        q.<span class="built_in">push</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Tree{</span><br><span class="line">    <span class="type">int</span> dfn[MN],dfntot,fa[MN],dep[MN],siz[MN],hson[MN],htop[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs1</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> pre)</span></span>{</span><br><span class="line">        siz[u]=<span class="number">1</span>;</span><br><span class="line">        fa[u]=pre;</span><br><span class="line">        dep[u]=dep[pre]<span class="number">+1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> v:adj[u]){</span><br><span class="line">            <span class="keyword">if</span>(v==pre) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">dfs1</span>(v,u);</span><br><span class="line">            siz[u]+=siz[v];</span><br><span class="line">            <span class="keyword">if</span>(siz[hson[u]]&lt;siz[v]) hson[u]=v;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs2</span><span class="params">(<span class="type">int</span> u,<span class="type">int</span> top)</span></span>{</span><br><span class="line">        htop[u]=top;</span><br><span class="line">        dfn[u]=++dfntot;</span><br><span class="line">        <span class="keyword">if</span>(!hson[u]) <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">dfs2</span>(hson[u],top);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> v:adj[u]){</span><br><span class="line">            <span class="keyword">if</span>(v==fa[u]||v==hson[u]) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="built_in">dfs2</span>(v,v);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lca</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>{</span><br><span class="line">        <span class="keyword">while</span>(htop[x]!=htop[y]){</span><br><span class="line">            <span class="keyword">if</span>(dep[htop[x]]&lt;dep[htop[y]]){</span><br><span class="line">                <span class="built_in">swap</span>(x,y);</span><br><span class="line">            }</span><br><span class="line">            x=fa[htop[x]];</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dep[x]&lt;dep[y]?x:y;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}<span class="keyword">using</span> <span class="keyword">namespace</span> Tree;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">cmp</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span>{</span><br><span class="line">    <span class="keyword">return</span> dfn[x]&lt;dfn[y];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        t.<span class="built_in">insert</span>(s,i);</span><br><span class="line">    }</span><br><span class="line">    t.<span class="built_in">build</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;=t.tot;i++){</span><br><span class="line">        adj[t.fail[i]].<span class="built_in">push_back</span>(i);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">dfs1</span>(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">dfs2</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    cin&gt;&gt;q;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(q--){</span><br><span class="line">        <span class="type">int</span> op,x;</span><br><span class="line">        string p;</span><br><span class="line">        cin&gt;&gt;op;</span><br><span class="line">        <span class="keyword">if</span>(op==<span class="number">1</span>){</span><br><span class="line">            cin&gt;&gt;p;</span><br><span class="line">            <span class="type">int</span> len=p.<span class="built_in">length</span>(),u=<span class="number">1</span>;</span><br><span class="line">            p=<span class="string">" "</span>+p;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=len;i++){</span><br><span class="line">                <span class="type">int</span> v=p[i]-<span class="string">'a'</span>;</span><br><span class="line">                u=t.t[u][v];</span><br><span class="line">                a[i]=u;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">sort</span>(a<span class="number">+1</span>,a<span class="number">+1</span>+len,cmp);</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=len;i++){</span><br><span class="line">                bit.<span class="built_in">modify</span>(dfn[a[i]],<span class="number">1</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;len;i++){</span><br><span class="line">                bit.<span class="built_in">modify</span>(dfn[<span class="built_in">lca</span>(a[i],a[i<span class="number">+1</span>])],<span class="number">-1</span>);</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            cin&gt;&gt;x;</span><br><span class="line">            <span class="type">int</span> p=t.end[x];</span><br><span class="line">            cout&lt;&lt;bit.<span class="built_in">query</span>(dfn[p]+siz[p]<span class="number">-1</span>)-bit.<span class="built_in">query</span>(dfn[p]<span class="number">-1</span>)&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="p2444-poi-2000病毒"><a class="markdownIt-Anchor" href="#p2444-poi-2000病毒"></a> P2444 POI 2000病毒</h2><p>本题即构造一个可行的无限长文本串，使没有任何子串为给出模式串中的一个。</p><p>那么，实际上就是我们永远都不会跳到某个病毒代码的终止节点，我们会一直在自动机上跑啊跑，也就是说，若能构造文本串，当且仅当自动机有成环，并且走到环的路径及其环内没有终止节点，DFS 判断即可：</p><p>等会这个和 Fail 树有啥关系？其实还是要理解跳 Fail 的本质是在干什么。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">3e4</span><span class="number">+15</span>;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">bool</span> vis[MN],inst[MN];</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ACAuto{</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span>{</span><br><span class="line">        <span class="type">int</span> ch[<span class="number">2</span>];</span><br><span class="line">        <span class="type">int</span> end,fail;</span><br><span class="line">    }t[MN];</span><br><span class="line">    <span class="type">int</span> tot;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> cp=c<span class="number">-48</span>;</span><br><span class="line">            <span class="keyword">if</span>(!t[p].ch[cp]) t[p].ch[cp]=++tot;</span><br><span class="line">            p=t[p].ch[cp];</span><br><span class="line">        }</span><br><span class="line">        t[p].end=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">1</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>].ch[i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>].ch[i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> f=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">1</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[f].ch[i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    t[v].fail=t[t[f].fail].ch[i];</span><br><span class="line">                    t[v].end|=t[t[t[f].fail].ch[i]].end;</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[f].ch[i]=t[t[f].fail].ch[i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}<span class="keyword">using</span> <span class="keyword">namespace</span> ACAuto;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(inst[u]){</span><br><span class="line">        cout&lt;&lt;<span class="string">"TAK"</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(vis[u]||t[u].end) <span class="keyword">return</span>;</span><br><span class="line">    inst[u]=vis[u]=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">dfs</span>(t[u].ch[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">dfs</span>(t[u].ch[<span class="number">1</span>]);</span><br><span class="line">    inst[u]=<span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string st;</span><br><span class="line">        cin&gt;&gt;st;</span><br><span class="line">        <span class="built_in">insert</span>(st);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">0</span>);</span><br><span class="line">    cout&lt;&lt;<span class="string">"NIE"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h1 id="4-数据结构结合"><a class="markdownIt-Anchor" href="#4-数据结构结合"></a> 4. 数据结构结合</h1><p>通过数据结构和 AC 自动机的完美，我们就可以通过快速维护某些信息来求解答案。</p><h2 id="p3121-censoring-g"><a class="markdownIt-Anchor" href="#p3121-censoring-g"></a> P3121 Censoring G</h2><p>多模式串匹配，考虑 AC 自动机，难点在于拼合过程。我们发现，一个字符匹配上之后就会删除，让后接着进行匹配，我们发现，只需要记录某个点在 Trie 图上匹配的位置就可以了，一旦成功匹配，我们只需要跳到这个单词的前一个字符的位置即可。考虑怎么维护，我们可以用栈来维护，删除逐个删除字符，加入一个一个加，时间复杂度是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 的：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">1e5</span><span class="number">+15</span>;</span><br><span class="line"><span class="type">int</span> n,top;</span><br><span class="line"><span class="type">int</span> s1[MN];</span><br><span class="line"><span class="type">char</span> s2[MN];</span><br><span class="line">string s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ACAuto{</span><br><span class="line">    <span class="type">int</span> tot,trie[MN][<span class="number">26</span>];</span><br><span class="line">    <span class="type">int</span> end[MN],fail[MN];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=c-<span class="string">'a'</span>;</span><br><span class="line">            <span class="keyword">if</span>(!trie[p][k]) trie[p][k]=++tot;</span><br><span class="line">            p=trie[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]=s.<span class="built_in">length</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="built_in">memset</span>(fail,<span class="number">0</span>,<span class="built_in">sizeof</span>(fail));</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(trie[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(trie[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">26</span>;i++){</span><br><span class="line">                <span class="keyword">if</span>(trie[u][i]){</span><br><span class="line">                    fail[trie[u][i]]=trie[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(trie[u][i]);</span><br><span class="line">                }<span class="keyword">else</span> trie[u][i]=trie[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">query</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            p=trie[p][c-<span class="string">'a'</span>];</span><br><span class="line">            s1[++top]=p;</span><br><span class="line">            s2[top]=c;</span><br><span class="line">            <span class="keyword">while</span>(end[p]){</span><br><span class="line">                top-=end[p];</span><br><span class="line">                p=top?s1[top]:<span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    cin&gt;&gt;s&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">        string awa;</span><br><span class="line">        cin&gt;&gt;awa;</span><br><span class="line">        ACAuto::<span class="built_in">insert</span>(awa);</span><br><span class="line">    }</span><br><span class="line">    ACAuto::<span class="built_in">build</span>();</span><br><span class="line">    ACAuto::<span class="built_in">query</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=top;i++) cout&lt;&lt;s2[i];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>是不是很水，能不能上一点难度啊！</p><h2 id="p5599-文本编辑器毕业题"><a class="markdownIt-Anchor" href="#p5599-文本编辑器毕业题"></a> P5599 文本编辑器（毕业题）</h2><p>？？？安详的睡去 XD。</p><p>没关系我们顺着 Subtask 一步一步来：</p><h3 id="subtask-1-2"><a class="markdownIt-Anchor" href="#subtask-1-2"></a> Subtask 1-2</h3><p>AC 自动机板子，14分 get！</p><h3 id="subtask-3"><a class="markdownIt-Anchor" href="#subtask-3"></a> Subtask 3</h3><p>只有一个模式串，要不要 KMP 呢？</p><p>但是正解显然不是让我们要用 KMP 啊，可是这里只有一个模式串耶？</p><p>我们考虑，一个匹配，当且仅当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>L</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[i-L+1,i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span> 是完全相同的，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">L</span></span></span></span> 为模式串的长度。我们不妨考虑设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo>−</mo><mi>L</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[i-L+1,i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span> 是否完全匹配，那么查询就是查<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><mo>∑</mo><mrow><mi>k</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>l</mi><mo>+</mo><mi>l</mi><mi>e</mi><mi>n</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow></munder><msub><mi>f</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">\sum\limits_{k \in [l+len-1,r]} f_{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.9660100000000003em;vertical-align:-1.216005em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.7500050000000001em"><span style="top:-2.058995em;margin-left:0"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03148em">k</span><span class="mrel mtight">∈</span><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:.01968em">l</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:.01968em">l</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:.02778em">r</span><span class="mclose mtight">]</span></span></span></span><span style="top:-3.0000050000000003em"><span class="pstrut" style="height:3em"></span><span><span class="mop op-symbol small-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.216005em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.33610799999999996em"><span style="top:-2.5500000000000003em;margin-left:-.10764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>，这是区间和，可以上线段树耶。</p><p>但是修改怎么办，我们注意到，修改实质上是一个循环，一次修改只会影响<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>+</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[l,r+L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span>（有循环截止部分），而我们的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 只需要判断出没出现过即可，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 显然会有一个长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi>t</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|t|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">∣</span><span class="mord mathnormal">t</span><span class="mord">∣</span></span></span></span> 的循环节，而且一定在经过<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">L</span></span></span></span> 个字符后出现，考虑对循环节之前的地方暴力，中间部分通过线段树打加法标记即可。</p><p>但是区间右端点在截止的时候也会修改，考虑把区间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>r</mi><mo separator="true">,</mo><mi>r</mi><mo>+</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(r,r+L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span> 的信息暴力修改就可以了，13 分 get！</p><h3 id="subtask-4"><a class="markdownIt-Anchor" href="#subtask-4"></a> Subtask 4</h3><p>没有修改！那我们就不用关心难受的循环节了哈哈哈。</p><p>现在问题转化为如何快速求出贡献之和，我们当然要建立起 AC 自动机，但是怎么维护区间呢？</p><p>我们考虑设<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span> 表示 AC 自动机上匹配<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mn>1</mn><mo>→</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[1\to i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span>，的时候，到达的点<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">u</span></span></span></span> 在 fail 树上子树中有多少终止节点。</p><p>不难发现一个对答案有贡献的字符串长度一定<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≤</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">\le L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.7719400000000001em;vertical-align:-.13597em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">L</span></span></span></span>，考虑对于一个询问<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span>，我们暴力求出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mi>l</mi><mo>→</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[l \to l+L-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.77777em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 所有字串对答案贡献，让后查询<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span></span></span></span> 在区间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l+L,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span> 的区间和就可以了。</p><p>让后就不会了啊啊啊啊啊啊。</p><h3 id="subtask-567114514"><a class="markdownIt-Anchor" href="#subtask-567114514"></a> Subtask 5,6,7,114514</h3><p>这部分参考了<a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cubHVvZ3UuY29tLmNuL2FydGljbGUvMnc2N2o1amc">s_r_f 的题解</a>。</p><p>其实答案就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mi>g</mi><mo stretchy="false">(</mo><mi>l</mi><mo separator="true">,</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum\limits f(i)+g(l,l+L-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-.25001em"></span><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g(l,r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">)</span></span></span></span> 表示<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mi>l</mi><mo>→</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[l \to r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span> 所有字串对答案的贡献，第二个很好求之前我们讲过，现在问题如何快速维护第一个。</p><p>每次区间修改的话必然会有循环节，但是我们只维护<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span></span></span></span> 是求不出来循环节的，我们考虑我们要知道什么信息才能维护循环节，通过 Sub 3 我们发现，暴力修改完<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,l+L-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 之后需要知道匹配到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mn>1</mn><mo>→</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[1\to l+L-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.77777em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 到 AC 自动机上的节点，也就是说，我们需要维护<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">u</span></span></span></span>。</p><p>我们考虑在线段树的节点维护两个信息：</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">u</span></span></span></span> 表示匹配<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo stretchy="false">[</mo><mn>1</mn><mo>→</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">s[1\to r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">s</span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span> 时到了 AC 自动机哪个节点。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">c</span></span></span></span> 表示区间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum\limits f(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-.25001em"></span><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span>。</li></ul><p>让后我们对于叶子节点我们还需要知道这个点是什么字符，这样方便我取维护<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo separator="true">,</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">u,c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal">u</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">c</span></span></span></span>。</p><p>对于一次查询，我们只需要<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[l,l+L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span> 暴力，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l+L,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span> 暴力查<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">c</span></span></span></span>。</p><p>怎么修改，首先前面<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>+</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">l+L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.77777em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal">L</span></span></span></span> 的部分还是暴力修改，让后我们查询<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l+L-1,l+L-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 这个叶子节点的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">u</span></span></span></span> 来求循环节，让后对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo>+</mo><mi>L</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l+L,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mclose">]</span></span></span></span> 进行区间修改，最后在对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>r</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>r</mi><mo>+</mo><mi>L</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[r+1,r+L]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8388800000000001em;vertical-align:-.19444em"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mclose">]</span></span></span></span> 所有的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal">u</span></span></span></span> 暴力修改以下即可。</p><p>没了？没了！（一脸震惊 Orz）</p><p>复杂度<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>62</mn><mo>×</mo><mo>∑</mo><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>+</mo><mi>q</mi><mo>×</mo><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo>+</mo><mi>L</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(62 \times \sum\limits |s_{i}|+q\times (\log n +L))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.02778em">O</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">2</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-.25001em"></span><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.7777700000000001em;vertical-align:-.19444em"></span><span class="mord mathnormal" style="margin-right:.03588em">q</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:.01389em">g</span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">L</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></p><p>代码如下：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> int long long</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="type">int</span> MN=<span class="number">1e6</span><span class="number">+15</span>,L=<span class="number">55</span>;</span><br><span class="line"><span class="type">int</span> n,m,q,id,f[MN],len[MN],sum[MN];</span><br><span class="line">string a,qry[MN];</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; pre[MN];</span><br><span class="line">unordered_map&lt;<span class="type">char</span>,<span class="type">int</span>&gt; mp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ACAuto</span>{</span><br><span class="line">    <span class="type">int</span> t[MN][<span class="number">62</span>],fail[MN],end[MN],tot;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(string s)</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> c:s){</span><br><span class="line">            <span class="type">int</span> k=mp[c];</span><br><span class="line">            <span class="keyword">if</span>(!t[p][k]) t[p][k]=++tot;</span><br><span class="line">            p=t[p][k];</span><br><span class="line">        }</span><br><span class="line">        end[p]++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">()</span></span>{</span><br><span class="line">        queue&lt;<span class="type">int</span>&gt; q;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">62</span>;i++){</span><br><span class="line">            <span class="keyword">if</span>(t[<span class="number">0</span>][i]) q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span>(!q.<span class="built_in">empty</span>()){</span><br><span class="line">            <span class="type">int</span> u=q.<span class="built_in">front</span>();</span><br><span class="line">            q.<span class="built_in">pop</span>();</span><br><span class="line">            end[u]+=end[fail[u]];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">62</span>;i++){</span><br><span class="line">                <span class="type">int</span> v=t[u][i];</span><br><span class="line">                <span class="keyword">if</span>(v){</span><br><span class="line">                    fail[v]=t[fail[u]][i];</span><br><span class="line">                    q.<span class="built_in">push</span>(v);</span><br><span class="line">                }<span class="keyword">else</span> t[u][i]=t[fail[u]][i];</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">getf</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++){</span><br><span class="line">            p=t[p][mp[a[i<span class="number">-1</span>]]];</span><br><span class="line">            f[i]=end[p];</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}ac;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Segment</span>{</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> ls p&lt;&lt;1</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> rs p&lt;&lt;1|1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Lazytag</span>{</span><br><span class="line">        <span class="type">int</span> id,hd;</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span>{</span><br><span class="line">        <span class="type">int</span> l,r,val;</span><br><span class="line">        Lazytag tag;</span><br><span class="line">    }t[MN&lt;&lt;<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> lpos;</span><br><span class="line">    string tmp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pushup</span><span class="params">(<span class="type">int</span> p)</span></span>{</span><br><span class="line">        t[p].val=t[ls].val+t[rs].val;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dotag</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> id,<span class="type">int</span> hd)</span></span>{</span><br><span class="line">        t[p].tag={id,hd};</span><br><span class="line">        <span class="type">int</span> bef=t[p].l-hd,lid=(t[p].r-bef)%len[id],rid=(t[p].r-bef)/len[id];</span><br><span class="line">        <span class="keyword">if</span>(rid==<span class="number">0</span>){</span><br><span class="line">            t[p].val=pre[id][lid]-(hd?pre[id][hd<span class="number">-1</span>]:<span class="number">0</span>);</span><br><span class="line">        }<span class="keyword">else</span> t[p].val=pre[id][lid]+rid*sum[id]-(hd?pre[id][hd<span class="number">-1</span>]:<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pushdown</span><span class="params">(<span class="type">int</span> p)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(t[p].tag.id){</span><br><span class="line">            <span class="type">int</span> id=t[p].tag.id,hd=t[p].tag.hd,val=(hd+(t[ls].r-t[ls].l<span class="number">+1</span>))%len[id];</span><br><span class="line">            <span class="built_in">dotag</span>(ls,id,hd);</span><br><span class="line">            <span class="built_in">dotag</span>(rs,id,val);</span><br><span class="line">            t[p].tag.id=<span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">build</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> l,<span class="type">int</span> r)</span></span>{</span><br><span class="line">        t[p].l=l;</span><br><span class="line">        t[p].r=r;</span><br><span class="line">        <span class="keyword">if</span>(l==r){</span><br><span class="line">            t[p].val=f[l];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="built_in">build</span>(ls,l,mid);</span><br><span class="line">        <span class="built_in">build</span>(rs,mid<span class="number">+1</span>,r);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">modifyt</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> fl,<span class="type">int</span> fr)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(t[p].l&gt;=fl&amp;&amp;t[p].r&lt;=fr){</span><br><span class="line">            <span class="built_in">dotag</span>(p,id,(t[p].l-lpos)%len[id]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">pushdown</span>(p);</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=fl) <span class="built_in">modifyt</span>(ls,fl,fr);</span><br><span class="line">        <span class="keyword">if</span>(mid&lt;fr) <span class="built_in">modifyt</span>(rs,fl,fr);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">modifyc</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> fl,<span class="type">int</span> fr,<span class="type">bool</span> tg)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(fl&gt;fr) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span>(t[p].l==t[p].r){</span><br><span class="line">            t[p].val=f[t[p].l];</span><br><span class="line">            <span class="keyword">if</span>(tg){</span><br><span class="line">                t[p].tag={id,(t[p].l-lpos)%len[id]};</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">pushdown</span>(p);</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=fl) <span class="built_in">modifyc</span>(ls,fl,fr,tg);</span><br><span class="line">        <span class="keyword">if</span>(mid&lt;fr) <span class="built_in">modifyc</span>(rs,fl,fr,tg);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">modify</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> fl,<span class="type">int</span> fr)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(fl&gt;fr) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span>(t[p].l==t[p].r){</span><br><span class="line">            <span class="keyword">if</span>(t[p].tag.id){</span><br><span class="line">                tmp+=qry[t[p].tag.id][t[p].tag.hd];</span><br><span class="line">            }<span class="keyword">else</span> tmp+=a[t[p].l<span class="number">-1</span>];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">pushdown</span>(p);</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=fl) <span class="built_in">modify</span>(ls,fl,fr);</span><br><span class="line">        <span class="keyword">if</span>(mid&lt;fr) <span class="built_in">modify</span>(rs,fl,fr);</span><br><span class="line">        <span class="built_in">pushup</span>(p);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> p,<span class="type">int</span> fl,<span class="type">int</span> fr)</span></span>{</span><br><span class="line">        <span class="keyword">if</span>(t[p].l&gt;=fl&amp;&amp;t[p].r&lt;=fr){</span><br><span class="line">            <span class="keyword">return</span> t[p].val;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">pushdown</span>(p);</span><br><span class="line">        <span class="type">int</span> mid=(t[p].l+t[p].r)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> ret=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(mid&gt;=fl) ret+=<span class="built_in">query</span>(ls,fl,fr);</span><br><span class="line">        <span class="keyword">if</span>(mid&lt;fr) ret+=<span class="built_in">query</span>(rs,fl,fr);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> ls</span></span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> rs</span></span><br><span class="line">}sg;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initmp</span><span class="params">()</span></span>{</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="string">'A'</span>;i&lt;=<span class="string">'Z'</span>;i++)mp[i]=i-<span class="string">'A'</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="string">'a'</span>;i&lt;=<span class="string">'z'</span>;i++)mp[i]=<span class="number">26</span>+(i-<span class="string">'a'</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="string">'0'</span>;i&lt;=<span class="string">'9'</span>;i++)mp[i]=<span class="number">52</span>+(i-<span class="string">'0'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">signed</span> <span class="title">main</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="built_in">initmp</span>();</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m&gt;&gt;q&gt;&gt;a;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++){</span><br><span class="line">        string s;</span><br><span class="line">        cin&gt;&gt;s;</span><br><span class="line">        ac.<span class="built_in">insert</span>(s);</span><br><span class="line">    }</span><br><span class="line">    ac.<span class="built_in">build</span>();</span><br><span class="line">    ac.<span class="built_in">getf</span>();</span><br><span class="line">    sg.<span class="built_in">build</span>(<span class="number">1</span>,<span class="number">1</span>,n);</span><br><span class="line">    <span class="keyword">while</span>(q--){</span><br><span class="line">        <span class="type">int</span> op,l,r,ls;</span><br><span class="line">        cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;</span><br><span class="line">        ls=r-l<span class="number">+1</span>;</span><br><span class="line">        sg.lpos=l;</span><br><span class="line">        <span class="keyword">if</span>(op==<span class="number">1</span>){</span><br><span class="line">            <span class="type">int</span> rpos=<span class="built_in">min</span>(r,l+L),ret=<span class="number">0</span>,p=<span class="number">0</span>;</span><br><span class="line">            sg.tmp=<span class="string">""</span>;</span><br><span class="line">            sg.<span class="built_in">modify</span>(<span class="number">1</span>,l,rpos);</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=l;i&lt;=rpos;i++){</span><br><span class="line">                p=ac.t[p][mp[sg.tmp[i-l]]];</span><br><span class="line">                ret+=ac.end[p];</span><br><span class="line">            }</span><br><span class="line">            cout&lt;&lt;ret+sg.<span class="built_in">query</span>(<span class="number">1</span>,rpos<span class="number">+1</span>,r)&lt;&lt;<span class="string">'\n'</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            string st;</span><br><span class="line">            cin&gt;&gt;st;</span><br><span class="line">            len[++id]=st.<span class="built_in">size</span>();</span><br><span class="line">            pre[id].<span class="built_in">resize</span>(len[id]);</span><br><span class="line">            <span class="type">int</span> lpos=<span class="built_in">max</span>(<span class="number">1ll</span>,l-L<span class="number">+1</span>),rpos=<span class="built_in">min</span>(n,r+L<span class="number">-1</span>);</span><br><span class="line">            <span class="type">int</span> p=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(ls&lt;=L*<span class="number">2</span>+len[id]*<span class="number">2</span>){</span><br><span class="line">                sg.tmp=<span class="string">""</span>;</span><br><span class="line">                sg.<span class="built_in">modify</span>(<span class="number">1</span>,lpos,rpos);</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=lpos;i&lt;=rpos;i++){</span><br><span class="line">                    <span class="type">char</span> ch=(i&lt;l||i&gt;r?sg.tmp[i-lpos]:st[(i-l)%len[id]]);</span><br><span class="line">                    p=ac.t[p][mp[ch]];</span><br><span class="line">                    <span class="keyword">if</span>(i&gt;=l) f[i]=ac.end[p];</span><br><span class="line">                }</span><br><span class="line">                sg.<span class="built_in">modifyc</span>(<span class="number">1</span>,l,r,<span class="number">1</span>);</span><br><span class="line">                sg.<span class="built_in">modifyc</span>(<span class="number">1</span>,r<span class="number">+1</span>,rpos,<span class="number">0</span>);</span><br><span class="line">            }<span class="keyword">else</span>{</span><br><span class="line">                <span class="type">int</span> led=l+L<span class="number">-1</span>,red=r-L<span class="number">+1</span>;</span><br><span class="line">                <span class="keyword">while</span>((led-l)%len[id]) led++;</span><br><span class="line">                sg.tmp=<span class="string">""</span>;</span><br><span class="line">                sg.<span class="built_in">modify</span>(<span class="number">1</span>,lpos,l<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=lpos;i&lt;led+len[id];i++){</span><br><span class="line">                    <span class="type">char</span> ch=(i&lt;l?sg.tmp[i-lpos]:st[(i-l)%len[id]]);</span><br><span class="line">                    p=ac.t[p][mp[ch]];</span><br><span class="line">                    <span class="keyword">if</span>(i&gt;=l){</span><br><span class="line">                        <span class="keyword">if</span>(i&lt;led) f[i]=ac.end[p];</span><br><span class="line">                        <span class="keyword">else</span> pre[id][i-led]=(i&gt;led?pre[id][i-led<span class="number">-1</span>]:<span class="number">0</span>)+ac.end[p];</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                sum[id]=pre[id][len[id]<span class="number">-1</span>];</span><br><span class="line">                sg.<span class="built_in">modifyc</span>(<span class="number">1</span>,l,led<span class="number">-1</span>,<span class="number">1</span>);</span><br><span class="line">                sg.<span class="built_in">modifyt</span>(<span class="number">1</span>,led,r);</span><br><span class="line"></span><br><span class="line">                sg.tmp=<span class="string">""</span>;</span><br><span class="line">                sg.<span class="built_in">modify</span>(<span class="number">1</span>,r<span class="number">+1</span>,rpos);</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=red;i&lt;=rpos;i++){</span><br><span class="line">                    <span class="type">char</span> ch=(i&gt;r?sg.tmp[i-r<span class="number">-1</span>]:st[(i-l)%len[id]]);</span><br><span class="line">                    p=ac.t[p][mp[ch]];</span><br><span class="line">                    <span class="keyword">if</span>(i&gt;r){</span><br><span class="line">                        f[i]=ac.end[p];</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                sg.<span class="built_in">modifyc</span>(<span class="number">1</span>,r<span class="number">+1</span>,rpos,<span class="number">0</span>);</span><br><span class="line">            }</span><br><span class="line">            qry[id]=st;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h1 id="5-后言"><a class="markdownIt-Anchor" href="#5-后言"></a> 5. 后言</h1><p>AC 自动机我用了 3 天的时间来钻研，感觉学到很多，但是感觉自己还是很菜 www，可能并没有完全理解 Fail 的本质，但是能完整做出来题就很不错了。</p><p>不要脸的求赞 www。</p><h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1><ul><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ3VhbmxleGlhbmdmYW4vcC8xNTMyNzYzOC5odG1s">Evitagen的FAil树</a></li><li>OI-Wiki</li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cubHVvZ3UuY29tLmNuL2FydGljbGUvMnc2N2o1amc">s_r_f 的文本编辑器题解</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYWxleC13ZWkvcC9BQ0FNLmh0bWw">alex-wei的AC好题</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2VpeGluMjAyNC9wLzE3MDQ3ODIxLmh0bWw">weixin2024的自动机上DP</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veWluZy1tZWkvcC8xNTE3NzUwOC5odG1s">ying_mei的在AC自动机上DP</a></li><li><a target="_blank" rel="external nofollow noopener noreferrer" href="/go.html?u=aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2M2MDEwOTc4MzYvYXJ0aWNsZS9kZXRhaWxzLzQ3MDQwNzAz">ThinerZQ的自动机讲解</a></li></ul></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>AC自动机的进阶应用</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://worldcpu.github.io/posts/6074ec1/">https://worldcpu.github.io/posts/6074ec1/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>wjyppm</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2025-06-29</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-09-28</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/">字符串</a></div><div class="post-share"><div class="social-share" data-image="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220808697_686ffa5e0afdb.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/social-share.js/1.0.16/css/share.min.css" media="print" onload='this.media="all"'><script src="https://s4.zstatic.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/d9450503/" title="浅谈FFT与NTT在字符串匹配中的应用"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212636113_686ffa99ef2da.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">浅谈FFT与NTT在字符串匹配中的应用</div></div><div class="info-2"><div class="info-item-1">0. 前言 记录做题中遇见的一些好玩的科技。 1. 含通用符的字符串匹配问题 在没有通用符的字符串匹配问题中，我们一般使用 O(n+m)O(n+m)O(n+m) 的 KMP，多模匹配下我们会考虑 AC 自动机。但是，我们还有令玩意中做法： 设 P(x)=∑i=0m−1(Ai−Bx+i)P(x)=\sum\limits_{i=0}^{m-1} (A_{i}-B_{x+i})P(x)=i=0∑m−1​(Ai​−Bx+i​)。 但是 Ai−Bx+iA_{i}-B_{x+i}Ai​−Bx+i​ 是没有正负性这一说的，所以我们要将其平方，有： P(x)=∑i=0m−1(Ai−Bx+i)2=∑i=0m−1(Ai2−2AiBx+i+Bx+i2)\begin{aligned} P(x) &amp; =\sum\limits_{i=0}^{m-1} (A_{i}-B_{x+i})^2 \\ &amp; =\sum\limits_{i=0}^{m-1} (A_{i}^2-2A_{i}B_{x+i}+B_{x+i}^2) \end{aligned} P(x)​=i=0∑m−1​(Ai​−Bx+i​...</div></div></div></a><a class="pagination-related" href="/posts/c64445da/" title="和哈希与随机赋权哈希"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212688653_686ffa4151534.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">和哈希与随机赋权哈希</div></div><div class="info-2"><div class="info-item-1">1. 定义 和哈希，又称集合哈希。 为什么叫集合哈希呢，集合与序列的不同点在于，集合是无序的，也就是说，序列要求每个位置一一相等，而集合只需要对应的元素出现次数相等即可。 我们引入一个问题： 给定一个长为 nnn 的序列 AAA，每次给出两个长度相等的区间 [l1,r1],[l2,r2][l_{1},r_{1}],[l_{2},r_{2}][l1​,r1​],[l2​,r2​] 里面的数排序后是否完全相等，我们就可以说 [2,3,1,4,5][2,3,1,4,5][2,3,1,4,5] 和 [5,4,3,2,1][5,4,3,2,1][5,4,3,2,1] 是相同的。 这种情况我们很难找到一个数据结构来支持这样的查询操作，我们发现如果称两个区间相同，那么这个区间里的每一个数的出现次数和另外一个区间中这个数的出现次数相同。 我们考虑，只需要次数相同就可以的话，那么也就是说，这哈希值之和我数值具体是多少，而和位置无关，那么两个区间相等的必要条件就是 h(l1,r1)=h(l2,r2)h(l_{1},r_{1})=h(l_{2},r_{2})h(l1​,r1​)=h(l2​,r2...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/18adad6c/" title="Fail树"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220825149_686ffa84cd11c.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-13</div><div class="info-item-2">Fail树</div></div><div class="info-2"><div class="info-item-1">0.引入 我们在写KMP的时候会求出来长度为nnn的字符串的前缀最长border的长度为Next[n]Next[n]Next[n]，接下来先介绍一个border 定义：对于一字符串SSS，用∣S∣|S|∣S∣表示其长度，后面我们简化用lenSlen_SlenS​来表示，那么SSS串的一个Border一定是SSS串的一个前缀，并且他前缀和后缀都能够相互匹配。举个例子，比如说“BeckyBe”的一个border就是Be,一个字符串的border可能有多个，但在这里我们要求的是最长的border 对于任意一个字符串SSS，一个Border的长度就对应一个Border（比如说上面的长度为2各border只能是“Be”），我们可以求出他所有border的长度分别为ne[ne[ne[lenSlen_SlenS​]，ne[ne[ne[ne[ne[ne[lenSlen_SlenS​]]]]]] 以此类推直到为0。根据上面的结论，我们可以知道，对一个字符串S求解next数组之后，我们就知道了S所有前缀（包括S自身）的所有Border了。 1.Fail树 fail树就是把所有next[i]n...</div></div></div></a><a class="pagination-related" href="/posts/94c0669/" title="SAM后缀自动机学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220812014_686ffa5e9bdaf.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-07</div><div class="info-item-2">SAM后缀自动机学习笔记</div></div><div class="info-2"><div class="info-item-1">0.前言 后缀自动机，在字符串算法中居于一种万能的地位，其本体代码编写较简单，优美的 O(n)O(n)O(n) 构建复杂度，是一类极其有用但难以真正理解的字符串后缀结构。笔者投入了大约一周的时间来学习，现在进行总结复习，看看能不能悟到一些新的东西。 同时后缀自动机本身的难度（10 级）决定了理解较难，笔者同时也是这样的感受。我在编写第一二三章节的时候会尽量用图来解释，尽量减少繁杂的符号化语言。必要的也不会省略。 后缀自动机在做习题的时候，需要有非常扎实的 DS 基础以及面向对象程序设计思想，不然在编写的时候就会炸掉（不然大纲为什么要有这个程序设计思想）。 一些基本约定： 本文章默认字符串下标从 111 开始。 我们用打字机字体表示字符串的内容，如：s=wjyppm1403s=\texttt{wjyppm1403}s=wjyppm1403。 拼接：s+ts+ts+t 表示将 ttt 拼接 sss 后。 字符集：即构成字符串中字符的集合。 空串：不含任何字符的字符串称为空串。 子串：在 sss 开头或末尾删去若干字符得到的字符串称作为 sss 的子串，sss 本身和空串也是 ss...</div></div></div></a><a class="pagination-related" href="/posts/517465e0/" title="manacher算法"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.picui.cn/free/2025/07/06/686a2182ad5e1.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-12</div><div class="info-item-2">manacher算法</div></div><div class="info-2"><div class="info-item-1">1.Manacher马拉车算法介绍 Manacher算法，又称马拉车算法。用于计算字符串每一个位置为对称中心的回文串长度，即可以用来查询一个长度为nnn的最长回文字串。他的时间复杂度是O(n)O(n)O(n)。是该情景中效率最高的（你不遍历整个字符串咋求出来） 回文串就是从头读到尾部和从尾部读到头都一样的字符串，例如“abbba”。一个回文串是镜像对称的，也就是说他反转之后也是和原串相同的，我们就是依靠这个性质来跑出马拉车算法的。 回文串有两种，一种是奇数的串，就是字符个数有奇数个。一种是偶数的串，例如“abba”就是一个。对于奇数的传，我们可以发现他的对称中心就是中间的‘b’，但是偶数的串呢。他就有2个对称中心，一个是第二个字符‘b’，一个是第三个字符‘b’（门前有两颗树，一颗是B树，另一个也是B树） 总之偶数的回文串对称中心有2个。 2.暴力法求解 不是说讲马拉车吗？怎么先给我讲暴力法啦？ 其实马拉车就是暴力法的改进。所以我们先讲讲暴力法如何求解。 我会枚举！，每次选一个点让后判断是不是回文串！ O(n3)O(n^3)O(n3) 我会优化！我们考虑到上述加粗的，一个回文串...</div></div></div></a><a class="pagination-related" href="/posts/469b7eaa/" title="后缀数组全家桶-从哈希乱搞到入门"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212693716_686ffa37946d9.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-03</div><div class="info-item-2">后缀数组全家桶-从哈希乱搞到入门</div></div><div class="info-2"><div class="info-item-1">可能更洛谷的阅读体验 0. 前言 后缀数组是信息学竞赛中解决字符串匹配的一大利器，其思想和实现非常简单。虽然倍增加排序的思想很简单，但是它的拓展 hththt 数组功能及其强大并且适用性广，在 OI 范围内广泛应用。 以下应用魏老师的一句话： 几乎所有字符串算法都存在一个共性：基于所求信息的特殊性质与已经求出的信息，使用增量法与势能分析求得所有信息。这体现了动态规划思想。—— Alex_Wei 希望读者也能好好利用这句话来理解字符串算法。 本文章包含后缀数组入门，以及应用，以及技巧及其好题选讲大礼包！ 但是作为本蒟蒻第一个写的算法全家桶，为了考虑到读者感受，写了一大堆没用的废话导致文章及其的长 ( •́ὤ•̀)，本文章共 2.1 万字，感谢管理员付出时间来进行审核。 一些基本约定： 本文章默认字符串下表从 111 开始。 我们用打字机字体表示字符串的内容，如：s=wjyppm1403s=\texttt{wjyppm1403}s=wjyppm1403。 拼接：s+ts+ts+t 表示将 ttt 拼接 sss 后。 字符集：即构成字符串中字符的集合。 空串：不含任何字符的字符...</div></div></div></a><a class="pagination-related" href="/posts/c64445da/" title="和哈希与随机赋权哈希"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212688653_686ffa4151534.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-29</div><div class="info-item-2">和哈希与随机赋权哈希</div></div><div class="info-2"><div class="info-item-1">1. 定义 和哈希，又称集合哈希。 为什么叫集合哈希呢，集合与序列的不同点在于，集合是无序的，也就是说，序列要求每个位置一一相等，而集合只需要对应的元素出现次数相等即可。 我们引入一个问题： 给定一个长为 nnn 的序列 AAA，每次给出两个长度相等的区间 [l1,r1],[l2,r2][l_{1},r_{1}],[l_{2},r_{2}][l1​,r1​],[l2​,r2​] 里面的数排序后是否完全相等，我们就可以说 [2,3,1,4,5][2,3,1,4,5][2,3,1,4,5] 和 [5,4,3,2,1][5,4,3,2,1][5,4,3,2,1] 是相同的。 这种情况我们很难找到一个数据结构来支持这样的查询操作，我们发现如果称两个区间相同，那么这个区间里的每一个数的出现次数和另外一个区间中这个数的出现次数相同。 我们考虑，只需要次数相同就可以的话，那么也就是说，这哈希值之和我数值具体是多少，而和位置无关，那么两个区间相等的必要条件就是 h(l1,r1)=h(l2,r2)h(l_{1},r_{1})=h(l_{2},r_{2})h(l1​,r1​)=h(l2​,r2...</div></div></div></a><a class="pagination-related" href="/posts/d9450503/" title="浅谈FFT与NTT在字符串匹配中的应用"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212636113_686ffa99ef2da.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-29</div><div class="info-item-2">浅谈FFT与NTT在字符串匹配中的应用</div></div><div class="info-2"><div class="info-item-1">0. 前言 记录做题中遇见的一些好玩的科技。 1. 含通用符的字符串匹配问题 在没有通用符的字符串匹配问题中，我们一般使用 O(n+m)O(n+m)O(n+m) 的 KMP，多模匹配下我们会考虑 AC 自动机。但是，我们还有令玩意中做法： 设 P(x)=∑i=0m−1(Ai−Bx+i)P(x)=\sum\limits_{i=0}^{m-1} (A_{i}-B_{x+i})P(x)=i=0∑m−1​(Ai​−Bx+i​)。 但是 Ai−Bx+iA_{i}-B_{x+i}Ai​−Bx+i​ 是没有正负性这一说的，所以我们要将其平方，有： P(x)=∑i=0m−1(Ai−Bx+i)2=∑i=0m−1(Ai2−2AiBx+i+Bx+i2)\begin{aligned} P(x) &amp; =\sum\limits_{i=0}^{m-1} (A_{i}-B_{x+i})^2 \\ &amp; =\sum\limits_{i=0}^{m-1} (A_{i}^2-2A_{i}B_{x+i}+B_{x+i}^2) \end{aligned} P(x)​=i=0∑m−1​(Ai​−Bx+i​...</div></div></div></a></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.luogu.com.cn/upload/usericon/578829.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">wjyppm</div><div class="author-info-description">高中蒟蒻信竟生</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Worldcpu"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Worldcpu" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="/wjyccgg1403@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#4a7dbe"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><div style="text-align:left;font-size:14px;line-height:1.6">👋🏻我是PPM，一个热爱编程和信息学竞赛的高中生，喜欢分享做题经验。本博客中所有 latex 公式均可以选中后复制哦😊<br><br>❓有问题欢迎提问，确保内容有意义。如需联系我，欢迎通过邮箱联系我！📧<br><br>嗷嗷！热烈欢迎🤪！来自<br><span style="color:#2679cc"><span id="province" style="white-space:nowrap"></span><span id="city"></span></span><br>的朋友，你好呀！<br>你的网络IP为：<span id="ip" style="display:inline-block;filter:blur(5px);transition:filter .5s ease">***.***.***.***</span><br><br><span id="greet"></span></div><script>!function(){const t=(new Date).getHours(),e=t<6?"🌠凌晨好，早点休息！":t<12?"🌤️ 早上好，快趁机多睡点懒觉！":t<18?"☀️下午好，精神满满！":"🌙晚上好，早点休息！";document.getElementById("greet").textContent=e,fetch("https://qifu-api.baidubce.com/ip/local/geo/v1/district").then(t=>t.json()).then(t=>{if("Success"!==t.code)return void console.warn("接口返回错误",t);const e=t.ip||"***.***.***.***",n=t.data.prov||"",o=t.data.city||"";document.getElementById("province").textContent=n,document.getElementById("city").textContent=o;const c=document.getElementById("ip");c.setAttribute("title",e),c.addEventListener("mouseenter",()=>{c.textContent=e,c.style.filter="blur(0)"}),c.addEventListener("mouseleave",()=>{c.textContent="***.***.***.***",c.style.filter="blur(5px)"})}).catch(t=>{console.error("接口调用失败",t)})}()</script></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">0. 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E8%87%AA%E5%8A%A8%E6%9C%BA%E4%B8%8E-ac-%E8%87%AA%E5%8A%A8%E6%9C%BA%E6%9C%AC%E8%B4%A8"><span class="toc-number">2.</span> <span class="toc-text">1. 自动机与 AC 自动机本质</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E8%87%AA%E5%8A%A8%E6%9C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 自动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-trie-%E4%B8%8E-ac-%E8%87%AA%E5%8A%A8%E6%9C%BA"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 Trie 与 AC 自动机</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-ac-%E8%87%AA%E5%8A%A8%E6%9C%BA%E4%B8%8A-dp"><span class="toc-number">3.</span> <span class="toc-text">2. AC 自动机上 DP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E7%8A%B6%E6%80%81%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 状态设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E4%BE%8B%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 例题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#usaco12jan-video-game-g"><span class="toc-number">3.2.1.</span> <span class="toc-text">USACO12JAN] Video Game G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jsoi2007-%E6%96%87%E6%9C%AC%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">3.2.2.</span> <span class="toc-text">JSOI2007 文本生成器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sdoi2014-%E6%95%B0%E6%95%B0"><span class="toc-number">3.2.3.</span> <span class="toc-text">SDOI2014 数数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cf696d-legen"><span class="toc-number">3.2.4.</span> <span class="toc-text">CF696D Legen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#uva1401-remeber-the-word"><span class="toc-number">3.2.5.</span> <span class="toc-text">UVA1401 Remeber the Word</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hnoi2004-l%E8%AF%AD%E8%A8%80"><span class="toc-number">3.2.6.</span> <span class="toc-text">HNOI2004 L语言</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-fail-%E6%A0%91"><span class="toc-number">4.</span> <span class="toc-text">3. Fail 树</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#p2414-noi2011-%E9%98%BF%E7%8B%B8%E7%9A%84%E6%89%93%E5%AD%97%E6%9C%BA"><span class="toc-number">4.1.</span> <span class="toc-text">P2414 [NOI2011] 阿狸的打字机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cf1437g"><span class="toc-number">4.2.</span> <span class="toc-text">CF1437G</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#p5840-divljak"><span class="toc-number">4.3.</span> <span class="toc-text">P5840 Divljak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#p2444-poi-2000%E7%97%85%E6%AF%92"><span class="toc-number">4.4.</span> <span class="toc-text">P2444 POI 2000病毒</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%BB%93%E5%90%88"><span class="toc-number">5.</span> <span class="toc-text">4. 数据结构结合</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#p3121-censoring-g"><span class="toc-number">5.1.</span> <span class="toc-text">P3121 Censoring G</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#p5599-%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8%E6%AF%95%E4%B8%9A%E9%A2%98"><span class="toc-number">5.2.</span> <span class="toc-text">P5599 文本编辑器（毕业题）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#subtask-1-2"><span class="toc-number">5.2.1.</span> <span class="toc-text">Subtask 1-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subtask-3"><span class="toc-number">5.2.2.</span> <span class="toc-text">Subtask 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subtask-4"><span class="toc-number">5.2.3.</span> <span class="toc-text">Subtask 4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#subtask-567114514"><span class="toc-number">5.2.4.</span> <span class="toc-text">Subtask 5,6,7,114514</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%90%8E%E8%A8%80"><span class="toc-number">6.</span> <span class="toc-text">5. 后言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/a6ad8815/" title="路线反思"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752220823460_686ffb1d0f61f.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="路线反思"></a><div class="content"><a class="title" href="/posts/a6ad8815/" title="路线反思">路线反思</a><time datetime="2025-09-28T13:08:28.000Z" title="发表于 2025-09-28 21:08:28">2025-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e9478aba/" title="猫树分治"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752212663165_686ffa507c01b.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="猫树分治"></a><div class="content"><a class="title" href="/posts/e9478aba/" title="猫树分治">猫树分治</a><time datetime="2025-09-21T13:46:02.000Z" title="发表于 2025-09-21 21:46:02">2025-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c8836e51/" title="MatrixTree矩阵树定理"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752211281055_686ffb41054b0_1_.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="MatrixTree矩阵树定理"></a><div class="content"><a class="title" href="/posts/c8836e51/" title="MatrixTree矩阵树定理">MatrixTree矩阵树定理</a><time datetime="2025-09-17T09:03:17.000Z" title="发表于 2025-09-17 17:03:17">2025-09-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/9dc41a00/" title="abc423题解"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1752221267079_686ffac98b90e.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="abc423题解"></a><div class="content"><a class="title" href="/posts/9dc41a00/" title="abc423题解">abc423题解</a><time datetime="2025-09-15T00:10:36.000Z" title="发表于 2025-09-15 08:10:36">2025-09-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/904f5191/" title="整体DP—从勤拿少取到量大管饱"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://7b594a30.cloudflare-imgbed-8n1.pages.dev/file/1757634776012_50f5f31f0d226d3652d507f8e96fb81f.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="整体DP—从勤拿少取到量大管饱"></a><div class="content"><a class="title" href="/posts/904f5191/" title="整体DP—从勤拿少取到量大管饱">整体DP—从勤拿少取到量大管饱</a><time datetime="2025-09-11T23:50:40.000Z" title="发表于 2025-09-12 07:50:40">2025-09-12</time></div></div></div></div></div></div></main><footer id="footer" style="background:0 0"><div class="footer-other"><div class="footer-copyright"><span class="copyright">©&nbsp;2025 By wjyppm</span><span class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://s4.zstatic.net/ajax/libs/fancyapps-ui/6.0.22/fancybox/fancybox.umd.js"></script><script src="https://s4.zstatic.net/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(async()=>{window.katex_js_css||(window.katex_js_css=!0,await btf.getCSS("https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css"),await btf.getScript("https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js")),document.querySelectorAll("#article-container .katex").forEach(t=>t.classList.add("katex-show"))})()</script><script>(()=>{const t="shuoshuo"===GLOBAL_CONFIG_SITE.pageType,e=null,s=t=>"dark"===t?"dark":"light",a=(a=document,o)=>{const n=t?{"data-mapping":"specific","data-term":o}:{"data-mapping":"pathname"},c=(t=>{const e=document.createElement("script");return Object.entries(t).forEach(([t,s])=>{e.setAttribute(t,s)}),e})({src:"https://giscus.app/client.js","data-repo":"Worldcpu/Worldcpu.github.io","data-repo-id":"R_kgDOOYWiqQ","data-category-id":"DIC_kwDOOYWiqc4CpBzT","data-theme":s(document.documentElement.getAttribute("data-theme")),"data-reactions-enabled":"1",crossorigin:"anonymous",async:!0,...e,...n});a.querySelector("#giscus-wrap").appendChild(c),t&&(window.shuoshuoComment.destroyGiscus=()=>{a.children.length&&(a.innerHTML="",a.classList.add("no-comment"))})};btf.addGlobalFn("themeChange",t=>{const e=document.querySelector("#giscus-wrap iframe");if(e){const a={giscus:{setConfig:{theme:s(t)}}};e.contentWindow.postMessage(a,"https://giscus.app")}},"giscus"),t?window.shuoshuoComment={loadComment:a}:a()})()</script></div><script async src="/js/diytitle.js"></script><script async src="/js/nav.js"></script><script src="https://s4.zstatic.net/ajax/libs/activate-power-mode/1.0.0/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script src="https://s4.zstatic.net/ajax/libs/pjax/0.2.8/pjax.js"></script><script>(()=>{window.pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:description"]','link[rel="canonical"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"],cacheBust:!1,analytics:!1,scrollRestoration:!1});const e=e=>{e&&Object.values(e).forEach(e=>e())};document.addEventListener("pjax:send",()=>{btf.removeGlobalFnEvent("pjaxSendOnce"),btf.removeGlobalFnEvent("themeChange");const t=document.body.classList;t.contains("read-mode")&&t.remove("read-mode"),e(window.globalFn.pjaxSend)}),document.addEventListener("pjax:complete",()=>{btf.removeGlobalFnEvent("pjaxCompleteOnce"),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),e(window.globalFn.pjaxComplete)}),document.addEventListener("pjax:error",e=>{if(404===e.request.status){!0?pjax.loadUrl("/404.html"):window.location.href="/404.html"}})})()</script><script async data-pjax="" src="https://s4.zstatic.net/ajax/libs/busuanzi/2.3.0/bsz.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>